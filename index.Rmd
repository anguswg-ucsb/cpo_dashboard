---
title: "CPO"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    css: www/custom.css
    navbar:
      - { icon: "fa-question-circle", href: "https://github.com/anguswg-ucsb/drought_data_processing", align: right }
    theme: cerulean
    orientation: columns
    source_code: embed
    vertical_layout: fill
---

```{r setup, include = FALSE}
library(shiny)
library(flexdashboard)
# libraries

library(tidyr)
library(dplyr)
library(purrr)
library(ggplot2)
# library(ggcorrplot)
# library(gghighlight)
library(kableExtra)
library(broom)
library(leaflet)
library(sf)
# library(huxtable)
# library(gtsummary) 
# library(patchwork)
# library(snakecase)
library(tools)
# library(tidymodels) # modeling
# library(jtools) # Linear regression exploration
# library(vip) # Variable importance  
# library(PerformanceAnalytics)
# library(mgcv)
# library(sjPlot)
library(plotly)
library(highcharter)
# library(car)
library(olsrr)
# library(tsibble)
# library(feasts)

source('data_utils.R')
```

 

```{r context="server"}


# districts for analysis
distr_num <- c(1,  2,  4,  5,  6,  7,  8,  9,  23, 64, 80,
               36, 37, # 38, 
               39, 45, 50, 51, 52, 53, 70, 72)
 

# short_year <- readRDS("model_data_year_v2")
short_year <- readRDS("model_data_year_v3.rds")

# water right model data
# by_right_quant <- readRDS("aggregated_by_right4.rds")

# # water right model data scaled
# by_right_scale <- readRDS("aggreg_by_right_scale2.rds")

breaks <- readRDS("admin_breaks.rds")


admin_dates <- readRDS("admin_dates.rds") %>% 
  mutate(date = as.character(date))

by_admin <- readRDS("by_admin.rds")

# district shapefile path
shp_path = "water_districts_simple.geojson"

 # load shapefiles as spatial polygon object
shp <- sf::read_sf(paste0(shp_path), quiet = TRUE) %>%
  filter(DISTRICT %in% distr_num) %>%
  st_transform(4326) %>% 
  st_cast("MULTIPOLYGON")

# Tidied MLR results by district
tidy_mlr <- readRDS("tidy_mlr.rds")

shp <- left_join(shp, tidy_mlr, by = c("DISTRICT" = "district"))

font <- list(
  # family      = "DM Sans",
  size        = 12,
  color       = "white"
  )

label <- list(
  bgcolor     = "#232F34",
  bordercolor = "transparent",
  font        = font
  )
# Initialize Maps 
output$districtMapMLR     <- renderLeaflet({ mlr_map(shp = shp) })
# output$districtMapLM     <- renderLeaflet({ basemap(shp = shp) })
```
Multiple linear regression
=====================================
Inputs {.sidebar}
-------------------------------------
### **TITLE**

<br> 

#### **SUBTITLE**

***

##### **SUMMARY INFO**

This area can be used for additional text/meta data if we'd like. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.


Column {data-width=500}
-------------------------------------
### Timeseries
```{r}
# plotly::plotlyOutput("wsTimeseries")
highcharter::highchartOutput("wsTimeseries")
```

```{r context = "server"}
observeEvent(input$districtMapMLR_click, {
   if(!is.null(input$districtMapMLR_click)) {
      click <- input$districtMapMLR_click %>%
            data.frame() %>%
            dplyr::select(lat,lng)
    
          pt <- sf::st_as_sf(
            click,
            coords = c("lng", "lat"),
            crs = 4326
            )
          # point intersection w/ polygons
          pt_intersect <-  st_filter(shp, pt)
    
          # ensure  app will not crash if a somewhere other than a shape is clicked and returns no results from point-shape intersection
          if(nrow(pt_intersect) == 0) {
              NULL
             } else {
           # } else if(outcome5() == "short_log") {
                district_id <- pt_intersect %>%
                    rename(district = DISTRICT) %>%
                    mutate(district = as.numeric(district))
                
                
                # ---- Water supply data summarized to the year ----
                ws_data <- by_admin %>%
                    group_by(year, district) %>%
                    mutate(
                        year          = as.factor(year),
                        admin_number  = as.integer(round(admin, 0))
                    ) %>%
                    dplyr::filter(!year %in% c(1980, 2013)) %>%
                    group_by(basin, district, year) %>%
                    summarise(
                        short               = sum(short, na.rm = T),
                        short_dir           = sum(short_dir, na.rm = T),
                        demand              = sum(demand, na.rm = T),
                        supply              = sum(supply, na.rm = T),
                        supply_dir          = sum(supply_dir, na.rm = T)
                      ) %>%
                    mutate(
                        short_norm          = 100*(round(short/demand, 3)),
                        short_dir_norm      = 100*(round(short_dir/demand, 3)),
                        aug_supply          = round((supply - supply_dir), 3),
                        aug_supply_norm     = round(100*(aug_supply/supply), 3),
                        year                = as.factor(year)
                    ) 
                # ---- Water supply data filter to district ----
                # ws_district <- ws_data %>% 
                #     # filter(district == 6)  %>% 
                #     filter(district == district_id$district)  %>% 
                #     mutate(
                #         year          = as.numeric(as.character(year)),
                #         aug_supply2   = aug_supply + supply_dir,
                #         demand2       = demand - aug_supply2
                #     ) %>% 
                #     rename(
                #         "Supply Augmented"    = aug_supply,
                #         "Demand"              = demand2,
                #         "Supply Direct flow"  = supply_dir,
                #         "Year"                = year
                #         ) %>% 
                #     pivot_longer(cols = c("Demand", "Supply Augmented", "Supply Direct flow"))
                # ---- Plot Water Supply/demand/shortage ----
                # stk_plot <- ws_plot(ws_district)
                # 
                # stk_plotly <- plotly::ggplotly(stk_plot, tooltip = c("x")) %>% 
                #                   style(hoverlabel = label) %>% 
                #                   layout(font = font,
                #                          yaxis = list(fixedrange = TRUE),
                #                          xaxis = list(fixedrange = TRUE)) %>% 
                #                   config(displayModeBar = F)
                
                       #  ---- render plotly plot ----
                # output$wsTimeseries <- renderPlotly({
                #       stk_plotly
                # })
                # ---- WIDE district demand, aug supply, supply data ----
                ws_wide <- ws_data %>%
                    # filter(district == 7)  %>%
                    filter(district == district_id$district)  %>%
                    mutate(
                      year        = as.numeric(as.character(year)),
                      aug_supply2 = aug_supply + supply_dir,
                      demand2     = demand - aug_supply2
                    ) %>%
                    rename(
                      "Supply Augmented2" = aug_supply2,
                      "Supply Augmented" = aug_supply,
                      "Demand" = demand,
                      "Demand_diff" = demand2,
                      "Supply Direct flow" = supply_dir)
                # ---- HC Dem/sup bar + shortage line ----
                stk_hc <- 
                  highchart() %>%
                      hc_plotOptions(column = list(stacking = 'normal'),
                                     line = list(marker = list(enabled = FALSE), lineWidth = 4)) %>%
                      hc_yAxis(title = list(text = "Water volume (M/gal)"), min = 0) %>%
                      # hc_yAxis_multiples(
                      #   list(title = list(text = "Shortage volume (M/Gal)"), min = 0, max = max(ws_wide$short_dir), opposite = TRUE),
                      #   list(title = list(text = "Water volume (M/gal)"), min = 0, max = max(ws_wide$Demand)) ) %>%
                      # hc_add_series( data = ws_wide, name = "Demand", type = 'column', hcaes(x = year, y = Demand_diff), yAxis = 1,
                      # fillOpacity = 0.3) %>%
                    hc_add_series(
                        data = ws_wide, name = "Total shortage",
                        type = 'column', hcaes(x = year, y = short),
                        # yAxis = 1, 
                        fillOpacity = 0.3) %>%
                        hc_add_series(
                        data = ws_wide, name = "Direct shortage",
                        type = 'column', hcaes(x = year, y = short_dir),
                        # yAxis = 1, 
                        fillOpacity = 0.3) %>%
                    hc_add_series(
                        data = ws_wide, name = "Augmented supply",
                        type = 'column', hcaes(x = year, y = `Supply Augmented`), 
                        # yAxis = 1, 
                        fillOpacity = 0.3) %>%
                    hc_add_series(
                        data = ws_wide, name = "Direct Flow Supply",
                        type = 'column',  hcaes(x = year, y = `Supply Direct flow`), 
                        # yAxis = 1, 
                        fillOpacity = 0.3) %>%
                    # hc_add_series(data = ws_wide, name = "Total shortage",type = 'line', hcaes(x = year, y = short), yAxis = 0)  %>%
                    # hc_add_series(data = ws_wide, name = "Direct shortage",type = 'line', hcaes(x = year, y = short_dir), yAxis = 0)  %>%
                    hc_add_series(
                        data = ws_wide, name = "Demand",
                        type = 'line', hcaes(x = year, y = Demand)
                        # yAxis = 1
                        )  %>%
                      hc_xAxis(categories = ws_wide$year) %>%
                      hc_colors(c("#a50000", "#E18686",  "#70BCE2", "#2984B2", "black")) %>%
                      hc_chart(plotBorderWidth = 0.5, plotBorderColor = '#b4b4b4', height = NULL)
                stk_hc
                #  ---- render plotly plot ----
                output$wsTimeseries <- renderHighchart({
                      stk_hc
                })
             }
          }
  })
```

### Predictors
```{r}
highcharter::highchartOutput("predictorTimeseries")
```

```{r context = "server"}
observeEvent(input$districtMapMLR_click, {
   if(!is.null(input$districtMapMLR_click)) {
      click <- input$districtMapMLR_click %>%
            data.frame() %>%
            dplyr::select(lat,lng)
    
          pt <- sf::st_as_sf(
            click,
            coords = c("lng", "lat"),
            crs = 4326
            )
          # point intersection w/ polygons
          pt_intersect <-  st_filter(shp, pt)
    
          # ensure  app will not crash if a somewhere other than a shape is clicked and returns no results from point-shape intersection
          if(nrow(pt_intersect) == 0) {
              NULL
             } else {
           # } else if(outcome5() == "short_log") {
                district_id <- pt_intersect %>%
                    rename(district = DISTRICT) %>%
                    mutate(district = as.numeric(district))
                
                # ---- Summarize data for MLR ----
                mlr_data <- by_admin %>%
                  group_by(year, district) %>%
                  mutate(
                    year          = as.factor(year),
                    admin_number  = as.integer(round(admin, 0))
                  ) %>%
                  dplyr::filter(!year %in% c(1980, 2013)) %>%
                  group_by(basin, district, year) %>%
                  summarise(
                      short               = sum(short, na.rm = T),
                      short_dir           = sum(short_dir, na.rm = T),
                      demand              = sum(demand, na.rm = T),
                      supply              = sum(supply, na.rm = T),
                      supply_dir          = sum(supply_dir, na.rm = T)
                  ) %>%
                  mutate(
                      short_norm          = 100*(round(short/demand, 3)),
                      short_dir_norm      = 100*(round(short_dir/demand, 3)),
                      aug_supply          = round((supply - supply_dir), 3),
                      aug_supply_norm     = round(100*(aug_supply/supply), 3),
                      year                = as.factor(year)
                  )
                
                ## ------ Join model data w/ admin level supply/demand/short -------
                mlr_district <- left_join(
                      mlr_data,
                      dplyr::select(short_year, year = wyear, district, 20:41),
                      by = c("district", "year")
                ) %>%
                  # filter(district == 8) %>%
                  filter(district == district_id$district) %>%
                  dplyr::filter(!year %in% c(1980, 2013)) %>%
                  # group_by(basin, district, water_right, year) %>%
                  group_by(basin, district, year) %>%
                  summarise(
                      short               = sum(short, na.rm = T),
                      short_dir           = sum(short_dir, na.rm = T),
                      demand              = sum(demand, na.rm = T),
                      supply              = sum(supply, na.rm = T),
                      supply_dir          = sum(supply_dir, na.rm = T),
                      af_total            = mean(af_total, na.rm = T),
                      swe_max             = mean(swe_max, na.rm = T),
                      prcp                = mean(prcp, na.rm = T),
                      prcp_norm           = mean(prcp_norm, na.rm = T),
                      pdsi                = mean(pdsi, na.rm = T),
                      pdsi_gridmet        = mean(pdsi_gridmet, na.rm = T),
                      eddi1               = mean(eddi1, na.rm = T),
                      eddi3               = mean(eddi3, na.rm = T),
                      eddi6               = mean(eddi6, na.rm = T),
                      eddi12              = mean(eddi12, na.rm = T),
                      spi1                = mean(spi1, na.rm = T),
                      spi3                = mean(spi3, na.rm = T),
                      spi6                = mean(spi6, na.rm = T),
                      spi9                = mean(spi9, na.rm = T),
                      spi12               = mean(spi12, na.rm = T),
                      tavg                = mean(tavg, na.rm = T),
                      aet                 = mean(aet, na.rm = T),
                      pet                 = mean(pet, na.rm = T),
                      soilm               = mean(soilm, na.rm = T)
                  ) %>%
                  mutate(
                      short_norm          = 100*(round(short/demand, 3)),
                      short_dir_norm      = 100*(round(short_dir/demand, 3)),
                      aug_supply          = round((supply - supply_dir), 3),
                      aug_supply_norm     = round(100*(aug_supply/supply), 3),
                      year                = as.factor(year)
                  ) %>%
                  ungroup()
                
                # ---- Prep data for model ----
                mod_df <- mlr_district %>%
                  dplyr::select(short_dir_norm, 10:11, 13:27)
                
                # ---- MLR Model + stepwise regression ----
                lm_vfit <- lm(short_dir_norm~., data = mod_df) %>%
                              # rm_collinearity(vif_thresh = 3.5) %>%
                              ols_step_forward_p()
                
                # ---- Select predictors from data ----
                ws_predictors <- mlr_district %>%
                    ungroup() %>%
                    dplyr::select(year, lm_vfit$predictors[1:2]) 
                
                # Fix names for axis, labels, titles
                pred_names <- names(rename_all(ws_predictors, recode,
                                        swe_max           = "SWE maximum",
                                        prcp              = "Precipitation",
                                        pdsi              = "PDSI",
                                        pdsi_gridmet      = "PDSI (gridMET)",
                                        eddi1             = "EDDI 1 month",
                                        eddi3             = "EDDI 3 month",
                                        eddi6             = "EDDI 6 month",
                                        eddi12            = "EDDI 12 month",
                                        spi1              = "SPI 1 month",
                                        spi3              = "SPI 3 month",
                                        spi6              = "SPI 6 month",
                                        spi9              = "SPI 9 month",
                                        spi12             = "SPI 12 month",
                                        tavg              = "Average temperature (C)",
                                        aet               = "Actual evapotranspiration",
                                        pet               = "Potential Evapotranspiration",
                                        soilm             = "Soil moisture")
                                    )
                
                # ---- Predictors highchart ----
                pred_hc <- 
                 highchart() %>%
                      hc_plotOptions(column = list(stacking = 'normal'),
                                     line = list(marker = list(enabled = FALSE), lineWidth = 4)) %>%
                      hc_yAxis(title = list(text = "Water volume (units)"), min = 0) %>%
                      hc_yAxis_multiples(
                        list(title = list(
                                text = pred_names[2]),
                                top = "0%",
                                height = "50%"
                             ),
                        list(title = list(
                                text = pred_names[3]),
                                top = "50%", 
                                height = "50%",
                                opposite = TRUE)
                      ) %>%
                      hc_add_series(
                            data = ws_predictors, 
                            name = pred_names[2],
                            type = 'line',
                            hcaes(x = year,  y = !!lm_vfit$predictors[1]),
                            yAxis = 0,
                            fillOpacity = 0.1) %>%
                      hc_add_series(
                            data = ws_predictors,
                            name = pred_names[3],
                            type = 'line', hcaes(x = year, y = !!lm_vfit$predictors[2]),
                            yAxis = 1, fillOpacity = 0.1) %>%
                      hc_xAxis(categories = ws_predictors$year) %>%
                      hc_colors(c("darkblue",  "darkred")) %>%
                      hc_chart(plotBorderWidth = 0.5, plotBorderColor = '#b4b4b4', height = NULL)
                
                #  ---- render predictors HC plot ----
                output$predictorTimeseries <- renderHighchart({
                      pred_hc
                })
             }
          }
  })
```


Column {data-width=250}
-----------------------------------------------------------------------
### 
```{r}
valueBoxOutput("districtBoxMLR")
```

### Water districts
```{r}
leafletOutput("districtMapMLR")
```


```{r context="server"}
# render district value box at start
output$districtBoxMLR <- renderValueBox(
                    valueBox(
                      value = "District", 
                      color = "success"
                  )
                )

# Clicking on map 1 outputs Value boxes on both pages + catchment polygons + Dat table + success panel
observeEvent(input$districtMapMLR_click, {
   if(!is.null(input$districtMapMLR_click)) {
      click <- input$districtMapMLR_click %>%
        data.frame() %>%
        dplyr::select(lat,lng)
      print(click)

      pt <- sf::st_as_sf(
        click,
        coords = c("lng", "lat"),
        crs = 4326
        )

      # point intersection w/ polygons
      pt_intersect <-  st_filter(shp, pt)

      # ensure  app will not crash if a somewhere other than a shape is clicked and returns no results from point-shape intersection
       if(nrow(pt_intersect) == 0) {
          NULL
       } else {
          district_id <- pt_intersect %>%
              rename(district = DISTRICT) %>%
              mutate(district = as.numeric(district))

          # District number value box
          output$districtBoxMLR <- renderValueBox(
            valueBox(
              value = paste0("District ", district_id$district),
              color = "success"
              )
            )
          pal <- colorNumeric("YlOrRd", domain = shp$variance_rsq, n = 21)
          bb = shp %>%
              st_bbox() %>%
              st_as_sfc() %>%
              st_transform(4326) %>%
              st_as_sf()
          # Map 2 fly to bounds
          bounds <- st_bbox(bb) %>%
              st_as_sfc() %>%
              st_buffer(0.009) %>%
              st_bbox() %>%
              as.vector()
       
          leafletProxy("districtMapMLR") %>%
              clearMarkers() %>%
              clearShapes() %>%
              addMarkers(data = pt) %>%
              addPolygons(
                    data = shp,
                    color = "black",
                    fillOpacity = 0.8,
                    fillColor = ~pal(variance_rsq),
                    weight = 2,
                    label = ~DISTRICT,
                    labelOptions = labelOptions(
                      noHide = F,
                      # direction = 'center',
                      # textOnly = F)
                      style = list(
                        "color" = "black",
                        "font-weight" = "1000")
                  )
                ) %>%
              # addLegend(
              #       data = shp,
              #       "bottomright",
              #       pal = pal,
              #       values = ~variance_rsq,
              #       title = "Variance x R2",
              #       labFormat = labelFormat(digits = 10,),
              #       opacity = 1
              #       ) %>% 
              # addPolygons(
              #           data = shp,
              #           fillColor = 'grey',
              #           fillOpacity = 0.3,
              #           col = "black",
              #           weight = 2,
              #           label = ~DISTRICT,
              #           labelOptions = labelOptions(
              #               noHide = F,
              #               # direction = 'center',
              #               # textOnly = F)
              #               style = list(
              #                 "color" = "black",
              #                 "font-weight" = "1000")
              #               )
              #           ) %>% 
              flyToBounds(bounds[1], bounds[2], bounds[3], bounds[4])
              # addLabelOnlyMarkers(
              #           data = centroids,
              #           label = ~DISTRICT,
              #           labelOptions = labelOptions(
              #                  noHide = TRUE,
              #                  direction = 'center',
              #                  textOnly = T,
              #                  style = list(
              #                            "color" = "black",
              #                            "font-weight" = "1000",
              #                            "font-size" = "9px",
              #                            "border" = "1.5px solid black",
              #                            "background-color"="LightCyan",
              #                            "border-color" = "rgba(0,0,0,0.9)"
              #                            )
              #                  )
              #           ) %>% 
       }
    }
})
```


```{r context="server"}
# render district value box at start
output$districtBoxMLR <- renderValueBox(
                    valueBox(
                      value = "District", 
                      color = "success"
                  )
                )

splitRightsMLR <- eventReactive(input$districtMapMLR_click, {
   click <- input$districtMapMLR_click %>%
        data.frame() %>%
        dplyr::select(lat,lng)

      pt <- sf::st_as_sf(
        click,
        coords = c("lng", "lat"),
        crs = 4326
        )

      # point intersection w/ polygons
      pt_intersect <-  st_filter(shp, pt)

      # ensure  app will not crash if a somewhere other than a shape is clicked and returns no results from point-shape intersection
      if(nrow(pt_intersect) == 0) {
          NULL
         } else {
            district_id <- pt_intersect %>%
                rename(district = DISTRICT) %>%
                mutate(district = as.numeric(district))
            
            # adm_date <- admin_dates %>% 
            #    filter(admin_number == adminNum())
             # filter(admin_number == 4900)
            
            # paste0(adminNum(), ": ", adm_date$date)
            breaks2 <- breaks %>% 
                    # filter(district == 6) %>%
                    filter(district == district_id$district) %>%
                    ungroup() %>% 
                    dplyr::select(split) %>% 
                    head(1)
            adm_date <- admin_dates %>%
                 filter(admin_number == breaks2[[1]])
            paste0(breaks2$split, ": ", adm_date$date)

         }
})


# Water rights admin number split value box
output$splitBoxMLR <- renderValueBox(
        valueBox(
          value   = paste0(splitRightsMLR()),
          caption = "Admin number: date",
          color   = "info"
          )
        )

# Clicking on map 1 outputs Value boxes on both pages + catchment polygons + Dat table + success panel
observeEvent(input$districtMapMLR_click, {
   if(!is.null(input$districtMapMLR_click)) {
      click <- input$districtMapMLR_click %>%
        data.frame() %>%
        dplyr::select(lat,lng)
      print(click)

      pt <- sf::st_as_sf(
        click,
        coords = c("lng", "lat"),
        crs = 4326
        )

      # point intersection w/ polygons
      pt_intersect <-  st_filter(shp, pt)

      # ensure  app will not crash if a somewhere other than a shape is clicked and returns no results from point-shape intersection
       if(nrow(pt_intersect) == 0) {
          NULL
       } else {
          district_id <- pt_intersect %>%
              rename(district = DISTRICT) %>%
              mutate(district = as.numeric(district))
          
          # District number value box
          output$districtBoxMLR <- renderValueBox(
            valueBox(
              value = paste0("District ", district_id$district),
              color = "success"
              )
            )
          bb = shp %>%
              st_bbox() %>%
              st_as_sfc() %>%
              st_transform(4326) %>%
              st_as_sf()
          # Map 2 fly to bounds
          bounds <- st_bbox(bb) %>%
              st_as_sfc() %>%
              st_buffer(0.009) %>%
              st_bbox() %>%
              as.vector()
          
          pal <- colorNumeric("YlOrRd", domain = shp$variance_rsq, n = 21)
          
          leafletProxy("districtMapMLR") %>%
              clearMarkers() %>%
              clearShapes() %>%
              addMarkers(data = pt) %>%
              addPolygons(
                      data = shp,
                      color = "black",
                      fillOpacity = 0.8,
                      fillColor = ~pal(variance_rsq),
                      weight = 2,
                      label = ~DISTRICT,
                      labelOptions = labelOptions(
                        noHide = F,
                        # direction = 'center',
                        # textOnly = F)
                        style = list(
                          "color" = "black",
                          "font-weight" = "1000")
                    )
                  ) %>%
                # addLegend(
                #         data = shp,
                #         "bottomright",
                #         pal = pal,
                #         values = ~variance_rsq,
                #         title = "Variance x R2",
                #         labFormat = labelFormat(digits = 10,),
                #         opacity = 1
                #       ) %>% 
              # addPolygons(
              #           data = shp,
              #           fillColor = 'grey',
              #           fillOpacity = 0.3,
              #           col = "black",
              #           weight = 2,
              #           label = ~DISTRICT,
              #           labelOptions = labelOptions(
              #               noHide = F,
              #               # direction = 'center',
              #               # textOnly = F)
              #               style = list(
              #                 "color" = "black",
              #                 "font-weight" = "1000")
              #               )
              #           ) %>% 
                flyToBounds(bounds[1], bounds[2], bounds[3], bounds[4])
       }
    }
})
```

### **Senior/Junior priority date**
```{r}
valueBoxOutput("splitBoxMLR")
```

### Observed vs. Simulated values
```{r}
highcharter::highchartOutput("MLRfittedPointPlot")
```

```{r context = "server"}
observeEvent(input$districtMapMLR_click, {
   if(!is.null(input$districtMapMLR_click)) {
      click <- input$districtMapMLR_click %>%
            data.frame() %>%
            dplyr::select(lat,lng)
    
          pt <- sf::st_as_sf(
            click,
            coords = c("lng", "lat"),
            crs = 4326
            )
          # point intersection w/ polygons
          pt_intersect <-  st_filter(shp, pt)
    
          # ensure  app will not crash if a somewhere other than a shape is clicked and returns no results from point-shape intersection
          if(nrow(pt_intersect) == 0) {
              NULL
             } else {
           # } else if(outcome5() == "short_log") {
                district_id <- pt_intersect %>%
                    rename(district = DISTRICT) %>%
                    mutate(district = as.numeric(district))
                
                
                # ---- Water supply data summarized to the year ----
                point_data <- by_admin %>%
                        group_by(year, district) %>%
                        mutate(
                            year          = as.factor(year),
                            admin_number  = as.integer(round(admin, 0))
                        ) %>%
                        dplyr::filter(!year %in% c(1980, 2013)) %>%
                        group_by(basin, district, year) %>%
                        summarise(
                            short               = sum(short, na.rm = T),
                            short_dir           = sum(short_dir, na.rm = T),
                            demand              = sum(demand, na.rm = T),
                            supply              = sum(supply, na.rm = T),
                            supply_dir          = sum(supply_dir, na.rm = T)
                        ) %>%
                        mutate(
                            short_norm          = 100*(round(short/demand, 3)),
                            short_dir_norm      = 100*(round(short_dir/demand, 3)),
                            aug_supply          = round((supply - supply_dir), 3),
                            aug_supply_norm     = round(100*(aug_supply/supply), 3),
                            year                = as.factor(year)
                        )

                ## ------ Join model data w/ admin level supply/demand/short -------
                point_data <- left_join(
                            point_data,
                            dplyr::select(short_year, year = wyear, district, 20:41),
                            by = c("district", "year")
                            ) %>%
                        # filter(district == 7) %>%
                        filter(district == district_id$district) %>%
                        dplyr::filter(!year %in% c(1980, 2013)) %>%
                        # group_by(basin, district, water_right, year) %>%
                        group_by(basin, district, year) %>%
                        summarise(
                              short               = sum(short, na.rm = T),
                              short_dir           = sum(short_dir, na.rm = T),
                              demand              = sum(demand, na.rm = T),
                              supply              = sum(supply, na.rm = T),
                              supply_dir          = sum(supply_dir, na.rm = T),
                              af_total            = mean(af_total, na.rm = T),
                              swe_max             = mean(swe_max, na.rm = T),
                              prcp                = mean(prcp, na.rm = T),
                              prcp_norm           = mean(prcp_norm, na.rm = T),
                              pdsi                = mean(pdsi, na.rm = T),
                              pdsi_gridmet        = mean(pdsi_gridmet, na.rm = T),
                              eddi1               = mean(eddi1, na.rm = T),
                              eddi3               = mean(eddi3, na.rm = T),
                              eddi6               = mean(eddi6, na.rm = T),
                              eddi12              = mean(eddi12, na.rm = T),
                              spi1                = mean(spi1, na.rm = T),
                              spi3                = mean(spi3, na.rm = T),
                              spi6                = mean(spi6, na.rm = T),
                              spi9                = mean(spi9, na.rm = T),
                              spi12               = mean(spi12, na.rm = T),
                              tavg                = mean(tavg, na.rm = T),
                              aet                 = mean(aet, na.rm = T),
                              pet                 = mean(pet, na.rm = T),
                              soilm               = mean(soilm, na.rm = T)
                              ) %>%
                        mutate(
                              short_norm          = 100*(round(short/demand, 3)),
                              short_dir_norm      = 100*(round(short_dir/demand, 3)),
                              aug_supply          = round((supply - supply_dir), 3),
                              aug_supply_norm     = round(100*(aug_supply/supply), 3),
                              year                = as.factor(year)
                              )
                  # subset data for MLR
                  mod_df <- point_data %>%
                        ungroup() %>%
                        dplyr::select(short_dir_norm, 10:11, 13:27)
                  
                  # MLR w/ VIF reduction + stepwise regression
                  mlr_vfit <- lm(short_dir_norm~., data = mod_df) %>%
                        # rm_collinearity(df = mod_df, vif_thresh = 3.5) %>%
                        ols_step_forward_p()
                  
                  fitted <- mlr_vfit$model$fitted.values # fitted values
                  observed <- mlr_vfit$model$model %>% dplyr::select(short_dir_norm) # Observed values
                  
                  # observed vs. fitted dataframe
                  pred_df <- data.frame(fitted = fitted, observed = observed) %>%  
                    setNames(c("Fitted", "Direct flow shortage normalized"))


                  obs_fit_hc <- 
                    highchart() %>%
                        hc_plotOptions(line = list(marker = list(enabled = FALSE)))%>% 
                        hc_yAxis(title = list(text = "Observed")) %>%
                        hc_xAxis(title = list(text = "Simulated")) %>%
                        hc_add_series(
                          data = pred_df, name = "Prediction",
                          type = 'point', hcaes(x = Fitted, y =  `Direct flow shortage normalized`),
                          yAxis = 0, fillOpacity = 0.1) %>% 
                        hc_add_series(
                          data = pred_df, name = "One to one line",
                          type = 'line', 
                          hcaes(x = `Direct flow shortage normalized`, y =  `Direct flow shortage normalized`),
                          yAxis = 0, fillOpacity = 0.1) 
                  
                #  ---- render plotly plot ----
                output$MLRfittedPointPlot <- renderHighchart({
                      obs_fit_hc
                })
             }
          }
  })
```

<!-- ### Admin numbers/dates -->
<!-- ```{r} -->
<!-- htmlOutput("adminDateTable") -->
<!-- ``` -->

```{r context = "server"}
# observeEvent(input$districtMapMLR_click, {
  #  if(!is.null(input$districtMapMLR_click)) {
  #     click <- input$districtMapMLR_click %>%
  #           data.frame() %>%
  #           dplyr::select(lat,lng)
  #   
  #         pt <- sf::st_as_sf(
  #           click,
  #           coords = c("lng", "lat"),
  #           crs = 4326
  #           )
  #         # point intersection w/ polygons
  #         pt_intersect <-  st_filter(shp, pt)
  #   
  #         # ensure  app will not crash if a somewhere other than a shape is clicked and returns no results from point-shape intersection
  #         if(nrow(pt_intersect) == 0) {
  #             NULL
  #            } else {
  #          # } else if(outcome5() == "short_log") {
  #               district_id <- pt_intersect %>%
  #                   rename(district = DISTRICT) %>%
  #                   mutate(district = as.numeric(district))
  #               
  #               # ---- Data wrangling by admin in Shiny ----
  #               by_admin2 <- by_admin %>%
  #                     group_by(year, district) %>%
  #                     # filter(district == 6) %>%
  #                     filter(district == district_id$district) %>%
  #                     mutate(
  #                       year         = as.factor(year),
  #                       admin_number = as.integer(round(admin, 0))
  #                     )
  #               # Join model data w/ admin level supply/demand/short
  #               split_admin <- left_join(
  #                     by_admin2,
  #                     dplyr::select(short_year, year = wyear, district),
  #                     by = c("district", "year")
  #                     ) %>%
  #                 dplyr::filter(!year %in% c(1980, 2013)) %>%
  #                 group_by(district, admin_number) %>%
  #                 summarise(
  #                     demand              = round(mean(demand, na.rm = T), 0)
  #    
  #                 ) %>%
  #                 ungroup() 
  #               
  #               # filter admin date table to only admin numbers that exist
  #               admin_date_table <- admin_dates %>%
  #                 filter(admin_number %in% split_admin$admin_number) %>%
  #                 # mutate(district = "6") %>%
  #                 mutate(district = as.character(district_id$district)) %>%
  #                 left_join(split_admin, by = c("admin_number", "district")) %>% 
  #                 dplyr::select(district, admin_number, date, demand)
  # 
  #               # admin_date_table
  #               admin_tbl <- kableExtra::kable(admin_date_table) %>%
  #                      kableExtra::kable_styling(
  #                       font_size = 12,
  #                       bootstrap_options = c("striped", "hover", "condensed")
  #                     ) 
  #               
  #               output$adminDateTable <- renderText({
  #                     admin_tbl 
  #                 })
  #            }
  #         }
  # })
```

