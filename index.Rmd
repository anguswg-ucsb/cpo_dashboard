---
title: "CPO"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    css: www/custom.css
    navbar:
      - { icon: "fa-question-circle", href: "https://github.com/anguswg-ucsb/drought_data_processing", align: right }
    theme: cerulean
    orientation: columns
    source_code: embed
    vertical_layout: fill
---

```{r setup, include = FALSE}
# Shiny & Flexdashboard libraries
library(shiny)
library(flexdashboard)

# Data libraries
library(tidyr)
library(dplyr)
library(purrr)
library(ggplot2)
library(kableExtra)
library(broom)
library(leaflet)
library(sf)
library(tools)
library(highcharter)
library(olsrr)
library(formattable)
library(shinyalert)
library(shinyBS)
library(reactable)

source('data_utils.R')
```

 

```{r context="server"}
useShinyalert(rmd = TRUE)

# districts for analysis
distr_num <- c(1,  2,  4,  5,  6,  7,  8,  9,  23, 64, 80,
               36, 37, # 38, 
               39, 45, 50, 51, 52, 53, 70, 72)

# dependent variable choices
# outcome_lst <- data.frame(outcome_variable = 
#                             c("short_total", "short_norm", 
#                               "short_dir_total", "short_dir_norm",
#                               "af_total")
#                           )
# # dependent variable choices
# outcome_lst_admin <- data.frame(outcome_variable = 
#                                   c("short", "short_norm", 
#                                     "short_dir", "short_dir_norm", "demand", "supply", "supply_dir",
#                                     "aug_supply", "aug_supply_norm", "af_total")
#                                 )
# 
# # outcomes for log trans selection inputs
# outcome_lst_log <- data.frame(outcome_variable = 
#                             c("short_log",  "short_dir_log")
#                           )
# 
# outcome_lst_log2 <- data.frame(outcome_variable = 
#                             c("short_log",  "short_dir_log", "short_norm_log", "short_dir_norm_log")
 
                         # )

indicator_lst <- list(
  "Precipitation (mm)"                 = "prcp",
  "SWE maximum (in)"                   = "swe_max",
  "Average temperature (C)"            = "tavg",
  "Actual Evapotranspiration (mm)"     = "aet",
  "Potential Evapotranspiration (mm)"  = "pet",
  "Soil moisture (mm)"                 = "soilm",
  "PDSI"                               = "pdsi",
  "PDSI (gridMET)"                     = "pdsi_gridmet",
  "EDDI 1 month"                       = "eddi1",
  "EDDI 3 month"                       = "eddi3",
  "EDDI 6 month"                       = "eddi6", 
  "EDDI 12 month"                      = "eddi12",
  "SPI 1 month"                        = "spi1",
  "SPI 3 month"                        = "spi3",
  "SPI 6 month"                        = "spi6",
  "SPI 9 month"                        = "spi9",
  "SPI 12 month"                       = "spi12"
  )

clim_model_indicator_lst <- list(
  "Precipitation (mm)"                 = "prcp",
  "Average temperature (C)"            = "tavg",
  "Maximum temperature (C)"            = "tmax",
  "Minimum temperature (C)"            = "tmin",
  "Potential Evapotranspiration (mm)"  = "pet",
  "PDSI"                               = "pdsi",
  # "Potential Evapotranspiration (mm)"  = "et_harg",
  # "PDSI (Hargreaves)"                  = "pdsi_harg",
  "SPI 1 month"                        = "spi1",
  "SPI 3 month"                        = "spi3",
  "SPI 6 month"                        = "spi6",
  "SPI 9 month"                        = "spi9",
  "SPI 12 month"                       = "spi12"
  )

impacts_lst <- list(
  "Total shortage (acre feet)"                 = "short",
  "Normalized total shortage (% of demand)"    = "short_norm",
  "Direct shortage (acre feet)"                = "short_dir",
  "Normalized direct shortage (% of demand)"   = "short_dir_norm",
  "Demand (acre feet)"                         = "demand",
  "Supply (acre feet)"                         = "supply",
  "Direct supply (acre feet)"                  = "supply_dir",
  "Natural flows (acre feet)"                  = "af_total"
)

dataset_lst <- list("MACA", "BCCA", "LOCA")

# impacts_lst <- list(
#   "Total shortage (acre feet)"                 = "short",
#   "Normalized total shortage (% of demand)"    = "short_norm",
#   "Direct shortage (acre feet)"                = "short_dir",
#   "Normalized direct shortage (% of demand)"   = "short_dir_norm",
#   "Natural flows (acre feet)"                  = "af_total"
# )
# indepent_lst <- data.frame(independent_variable =   
#                              c("prcp", "prcp_pct_norm", "aet", "pet", "soilm", "pdsi","pdsi_gridmet", "eddi1","eddi3", "eddi6", "eddi12",
#                               "spi1", "spi3", "spi6", "spi9", "spi12","tavg", "swe_max") )

# indepent_lst2 <- data.frame(independent_variable =   
#                                c("Precipitation","SWE maximum",  "Average temperature","Actual Evapotranspiration", "Potential Evapotranspiration", "Soil moisture","PDSI","PDSI (gridMET)", "EDDI 1 month", "EDDI 3 month", "EDDI 6 month",  "EDDI 12 month",
#                                   "SPI 1 month", "SPI 3 month","SPI 6 month","SPI 9 month","SPI 12 month")
                           # )
# # dependent variable choices
# outcome_lst <- data.frame(outcome_variable = 
#                             c("short_total", "short_norm","short_dir_total", "short_dir_norm",  "af_total")
#                           )
# # dependent variable choices
# outcome_lst2 <- data.frame(outcome_variable = 
#                             c("Total shortage",  "Normalized total shortage","Direct shortage",  "Normalized direct shortage",  "Natural flows")       )
                         

# short_year <- readRDS("model_data_year_v2")
short_year <- readRDS("model_data_year_v3.rds")

# water right model data
# by_right_quant <- readRDS("aggregated_by_right4.rds")

# # water right model data scaled
# by_right_scale <- readRDS("aggreg_by_right_scale2.rds")

breaks <- readRDS("admin_breaks.rds")


admin_dates <- readRDS("admin_dates.rds") %>% 
  mutate(date = as.character(date))

by_admin <- readRDS("by_admin.rds")

# district shapefile path
shp_path = "water_districts_simple.geojson"

 # load shapefiles as spatial polygon object
shp <- sf::read_sf(paste0(shp_path), quiet = TRUE) %>%
  filter(DISTRICT %in% distr_num) %>%
  st_transform(4326) %>% 
  st_cast("MULTIPOLYGON")

# Tidied MLR results by district
tidy_mlr <- readRDS("tidy_mlr.rds")

shp <- left_join(shp, tidy_mlr, by = c("DISTRICT" = "district"))

font <- list(
  # family      = "DM Sans",
  size        = 12,
  color       = "white"
  )

label <- list(
  bgcolor     = "#232F34",
  bordercolor = "transparent",
  font        = font
  )

# node_pts <- readRDS("node_pts.rds")
# node_pts <- readRDS("node_pts2.rds")
node_pts <- readRDS("node_pts3.rds")

# ditch_data <- readRDS("ditch_data.rds")
ditch_data <- readRDS("ditch_data2.rds")

ditch_names <- readRDS("ditch_names2.rds")

climate_models <- readRDS("climate_models.rds") %>% 
  rename(pet = et_thorn, pet_harg = et_harg, pdsi = pdsi_thorn)

climate_samples <- readRDS("maca_tidy_samples.rds") %>% 
  rename(pet_hist = et_hist, pet_future = et_future)

# future_samples <- readRDS("maca_future_samples.rds")
# hist_samples <- readRDS("maca_historic_samples.rds")

# Initialize Maps 
output$districtMapMLR       <- renderLeaflet({ mlr_map(shp = shp) })
output$districtMapLM        <- renderLeaflet({ basemap(shp = shp) })
output$districtMap          <- renderLeaflet({ mlr_map(shp = shp) })
output$nodeMap              <- renderLeaflet({ basemap(shp = shp) })
output$districtMapFuture    <- renderLeaflet({ basemap(shp = shp) })
```

Multiple linear regression 
=====================================
Inputs {.sidebar}
----------------------------------------------------
### **TITLE**

<br> 

#### **SUBTITLE**

***

This area can be used for additional text/meta data if we'd like. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud 

Column {data-width=250}
-----------------------------------------------------------------------
### 
```{r}
valueBoxOutput("districtBoxMLR")
```

### Water districts
```{r}
leafletOutput("districtMapMLR")
bsTooltip("districtMapMLR", "INSERT TEXT HERE",
                    "bottom", options = list(container = "body"))
```


```{r context="server"}
# render district value box at start
output$districtBoxMLR <- renderValueBox(
                    valueBox(
                      value = "District", 
                      color = "success"
                  )
                )

# Clicking on map 1 outputs Value boxes on both pages + catchment polygons + Dat table + success panel
observeEvent(input$districtMapMLR_click, {
   if(!is.null(input$districtMapMLR_click)) {
      click <- input$districtMapMLR_click %>%
        data.frame() %>%
        dplyr::select(lat,lng)
      print(click)

      pt <- sf::st_as_sf(
        click,
        coords = c("lng", "lat"),
        crs = 4326
        )

      # point intersection w/ polygons
      pt_intersect <-  st_filter(shp, pt)

      # ensure  app will not crash if a somewhere other than a shape is clicked and returns no results from point-shape intersection
       if(nrow(pt_intersect) == 0) {
          NULL
       } else {
          district_id <- pt_intersect %>%
              rename(district = DISTRICT) %>%
              mutate(district = as.numeric(district))

          # District number value box
          output$districtBoxMLR <- renderValueBox(
            valueBox(
              value = paste0("District ", district_id$district),
              color = "success"
              )
            )
          pal <- colorNumeric("YlOrRd", domain = shp$variance_rsq, n = 21)
          bb = shp %>%
              st_bbox() %>%
              st_as_sfc() %>%
              st_transform(4326) %>%
              st_as_sf()
          # Map 2 fly to bounds
          bounds <- st_bbox(bb) %>%
              st_as_sfc() %>%
              st_buffer(0.009) %>%
              st_bbox() %>%
              as.vector()
       
          leafletProxy("districtMapMLR") %>%
              clearMarkers() %>%
              clearShapes() %>%
              addMarkers(data = pt) %>%
              addPolygons(
                    data = shp,
                    color = "black",
                    fillOpacity = 0.8,
                    fillColor = ~pal(variance_rsq),
                    weight = 2,
                    label = ~DISTRICT,
                    labelOptions = labelOptions(
                      noHide = F,
                      # direction = 'center',
                      # textOnly = F)
                      style = list(
                        "color" = "black",
                        "font-weight" = "1000")
                  )
                ) 
              # addLegend(
              #       data = shp,
              #       "bottomright",
              #       pal = pal,
              #       values = ~variance_rsq,
              #       title = "Variance x R2",
              #       labFormat = labelFormat(digits = 10,),
              #       opacity = 1
              #       ) %>% 
              # addPolygons(
              #           data = shp,
              #           fillColor = 'grey',
              #           fillOpacity = 0.3,
              #           col = "black",
              #           weight = 2,
              #           label = ~DISTRICT,
              #           labelOptions = labelOptions(
              #               noHide = F,
              #               # direction = 'center',
              #               # textOnly = F)
              #               style = list(
              #                 "color" = "black",
              #                 "font-weight" = "1000")
              #               )
              #           ) %>% 
              # flyToBounds(bounds[1], bounds[2], bounds[3], bounds[4])
              # addLabelOnlyMarkers(
              #           data = centroids,
              #           label = ~DISTRICT,
              #           labelOptions = labelOptions(
              #                  noHide = TRUE,
              #                  direction = 'center',
              #                  textOnly = T,
              #                  style = list(
              #                            "color" = "black",
              #                            "font-weight" = "1000",
              #                            "font-size" = "9px",
              #                            "border" = "1.5px solid black",
              #                            "background-color"="LightCyan",
              #                            "border-color" = "rgba(0,0,0,0.9)"
              #                            )
              #                  )
              #           ) %>% 
       }
    }
})
```


```{r context="server"}
# render district value box at start
output$districtBoxMLR <- renderValueBox(
                    valueBox(
                      value = "District", 
                      color = "success"
                  )
                )

splitRightsMLR <- eventReactive(input$districtMapMLR_click, {
   click <- input$districtMapMLR_click %>%
        data.frame() %>%
        dplyr::select(lat,lng)

      pt <- sf::st_as_sf(
        click,
        coords = c("lng", "lat"),
        crs = 4326
        )

      # point intersection w/ polygons
      pt_intersect <-  st_filter(shp, pt)

      # ensure  app will not crash if a somewhere other than a shape is clicked and returns no results from point-shape intersection
      if(nrow(pt_intersect) == 0) {
          NULL
         } else {
            district_id <- pt_intersect %>%
                rename(district = DISTRICT) %>%
                mutate(district = as.numeric(district))
            
            # adm_date <- admin_dates %>% 
            #    filter(admin_number == adminNum())
             # filter(admin_number == 4900)
            
            # paste0(adminNum(), ": ", adm_date$date)
            breaks2 <- breaks %>% 
                    # filter(district == 7) %>%
                    filter(district == district_id$district) %>%
                    ungroup() %>% 
                    filter(demand_cuml_tot == split) %>% 
                    dplyr::select(admin_number) %>% 
                    head(1)
            adm_date <- admin_dates %>%
                 filter(admin_number == breaks2[[1]])
            paste0(breaks2$admin_number, ": ", adm_date$date)

         }
})


# Water rights admin number split value box
output$splitBoxMLR <- renderValueBox(
        valueBox(
          value   = paste0(splitRightsMLR()),
          caption = "Priority date",
          color   = "success"
          )
        )

# Clicking on map 1 outputs Value boxes on both pages + catchment polygons + Dat table + success panel
observeEvent(input$districtMapMLR_click, {
   if(!is.null(input$districtMapMLR_click)) {
      click <- input$districtMapMLR_click %>%
        data.frame() %>%
        dplyr::select(lat,lng)
      print(click)

      pt <- sf::st_as_sf(
        click,
        coords = c("lng", "lat"),
        crs = 4326
        )

      # point intersection w/ polygons
      pt_intersect <-  st_filter(shp, pt)

      # ensure  app will not crash if a somewhere other than a shape is clicked and returns no results from point-shape intersection
       if(nrow(pt_intersect) == 0) {
          NULL
       } else {
          district_id <- pt_intersect %>%
              rename(district = DISTRICT) %>%
              mutate(district = as.numeric(district))
          
          # District number value box
          output$districtBoxMLR <- renderValueBox(
            valueBox(
              value = paste0("District ", district_id$district),
              color = "success"
              )
            )
          bb = shp %>%
              st_bbox() %>%
              st_as_sfc() %>%
              st_transform(4326) %>%
              st_as_sf()
          # Map 2 fly to bounds
          bounds <- st_bbox(bb) %>%
              st_as_sfc() %>%
              st_buffer(0.009) %>%
              st_bbox() %>%
              as.vector()
          
          pal <- colorNumeric("YlOrRd", domain = shp$variance_rsq, n = 21)
          
          leafletProxy("districtMapMLR") %>%
              clearMarkers() %>%
              clearShapes() %>%
              addMarkers(data = pt) %>%
              addPolygons(
                      data = shp,
                      color = "black",
                      fillOpacity = 0.8,
                      fillColor = ~pal(variance_rsq),
                      weight = 2,
                      label = ~DISTRICT,
                      labelOptions = labelOptions(
                        noHide = F,
                        # direction = 'center',
                        # textOnly = F)
                        style = list(
                          "color" = "black",
                          "font-weight" = "1000")
                    )
                  ) 
                # addLegend(
                #         data = shp,
                #         "bottomright",
                #         pal = pal,
                #         values = ~variance_rsq,
                #         title = "Variance x R2",
                #         labFormat = labelFormat(digits = 10,),
                #         opacity = 1
                #       ) %>% 
              # addPolygons(
              #           data = shp,
              #           fillColor = 'grey',
              #           fillOpacity = 0.3,
              #           col = "black",
              #           weight = 2,
              #           label = ~DISTRICT,
              #           labelOptions = labelOptions(
              #               noHide = F,
              #               # direction = 'center',
              #               # textOnly = F)
              #               style = list(
              #                 "color" = "black",
              #                 "font-weight" = "1000")
              #               )
              #           ) %>% 
                # flyToBounds(bounds[1], bounds[2], bounds[3], bounds[4])
       }
    }
})
```

### **Priority date**
```{r}
# observe_helpers()
# 
# output$dynamicUI <- renderUI({
# valueBoxOutput("splitBoxMLR") %>%
#     helper(icon = "question",
#              colour = "orange",
#              size = "s",
#              type = "inline",
#              title = "Current Details")
#   })
valueBoxOutput("splitBoxMLR")
bsTooltip("splitBoxMLR", "INSERT TEXT HERE",
                    "bottom", options = list(container = "body"))
# uiOutput("dynamicUI")
```

### Model Performance
```{r}
highcharter::highchartOutput("MLRfittedPointPlot")
bsTooltip("MLRfittedPointPlot", "INSERT TEXT HERE",
                    "top", options = list(container = "body"))
```

```{r context = "server"}

observeEvent(input$districtMapMLR_click, {
   if(!is.null(input$districtMapMLR_click)) {
      click <- input$districtMapMLR_click %>%
            data.frame() %>%
            dplyr::select(lat,lng)
    
          pt <- sf::st_as_sf(
            click,
            coords = c("lng", "lat"),
            crs = 4326
            )
          # point intersection w/ polygons
          pt_intersect <-  st_filter(shp, pt)
    
          # ensure  app will not crash if a somewhere other than a shape is clicked and returns no results from point-shape intersection
          if(nrow(pt_intersect) == 0) {
              NULL
             } else {
           # } else if(outcome5() == "short_log") {
                district_id <- pt_intersect %>%
                    rename(district = DISTRICT) %>%
                    mutate(district = as.numeric(district))
                
                
                # ---- Water supply data summarized to the year ----
                point_data <- by_admin %>%
                        group_by(year, district) %>%
                        mutate(
                            year          = as.factor(year),
                            admin_number  = as.integer(round(admin, 0))
                        ) %>%
                        dplyr::filter(!year %in% c(1980, 2013)) %>%
                        group_by(basin, district, year) %>%
                        summarise(
                            short               = sum(short, na.rm = T),
                            short_dir           = sum(short_dir, na.rm = T),
                            demand              = sum(demand, na.rm = T),
                            supply              = sum(supply, na.rm = T),
                            supply_dir          = sum(supply_dir, na.rm = T)
                        ) %>%
                        mutate(
                            short_norm          = 100*(round(short/demand, 3)),
                            short_dir_norm      = 100*(round(short_dir/demand, 3)),
                            aug_supply          = round((supply - supply_dir), 3),
                            aug_supply_norm     = round(100*(aug_supply/supply), 3),
                            year                = as.factor(year)
                        )

                ## ------ Join model data w/ admin level supply/demand/short -------
                point_data <- left_join(
                            point_data,
                            dplyr::select(short_year, year = wyear, district, 20:41),
                            by = c("district", "year")
                            ) %>%
                        # filter(district == 7) %>%
                        filter(district == district_id$district) %>%
                        dplyr::filter(!year %in% c(1980, 2013)) %>%
                        # group_by(basin, district, water_right, year) %>%
                        group_by(basin, district, year) %>%
                        summarise(
                              short               = sum(short, na.rm = T),
                              short_dir           = sum(short_dir, na.rm = T),
                              demand              = sum(demand, na.rm = T),
                              supply              = sum(supply, na.rm = T),
                              supply_dir          = sum(supply_dir, na.rm = T),
                              af_total            = mean(af_total, na.rm = T),
                              swe_max             = mean(swe_max, na.rm = T),
                              prcp                = mean(prcp, na.rm = T),
                              prcp_norm           = mean(prcp_norm, na.rm = T),
                              pdsi                = mean(pdsi, na.rm = T),
                              pdsi_gridmet        = mean(pdsi_gridmet, na.rm = T),
                              eddi1               = mean(eddi1, na.rm = T),
                              eddi3               = mean(eddi3, na.rm = T),
                              eddi6               = mean(eddi6, na.rm = T),
                              eddi12              = mean(eddi12, na.rm = T),
                              spi1                = mean(spi1, na.rm = T),
                              spi3                = mean(spi3, na.rm = T),
                              spi6                = mean(spi6, na.rm = T),
                              spi9                = mean(spi9, na.rm = T),
                              spi12               = mean(spi12, na.rm = T),
                              tavg                = mean(tavg, na.rm = T),
                              aet                 = mean(aet, na.rm = T),
                              pet                 = mean(pet, na.rm = T),
                              soilm               = mean(soilm, na.rm = T)
                              ) %>%
                        mutate(
                              short_norm          = 100*(round(short/demand, 3)),
                              short_dir_norm      = 100*(round(short_dir/demand, 3)),
                              aug_supply          = round((supply - supply_dir), 3),
                              aug_supply_norm     = round(100*(aug_supply/supply), 3),
                              year                = as.factor(year)
                              )
                  # subset data for MLR
                  mod_df <- point_data %>%
                        ungroup() %>%
                        dplyr::select(short_dir_norm, 10:11, 13:27)
                  
                  # MLR w/ VIF reduction + stepwise regression
                  mlr_vfit <- lm(short_dir_norm~., data = mod_df) %>%
                        # rm_collinearity(df = mod_df, vif_thresh = 3.5) %>%
                        ols_step_forward_p()
                  
                  fitted <- mlr_vfit$model$fitted.values # fitted values
                  observed <- mlr_vfit$model$model %>% dplyr::select(short_dir_norm) # Observed values
                  
                  # rsquared <- mlr_vfit$metrics[1] %>% 
                  #   round(3) %>% 
                  #   as.character()
                  # 
                  
                  # observed vs. fitted dataframe
                  pred_df <- data.frame(fitted = fitted, observed = observed) %>%  
                    setNames(c("Fitted", "Direct flow shortage normalized"))


                  obs_fit_hc <- 
                    highchart() %>%
                        hc_plotOptions(line = list(marker = list(enabled = FALSE)))%>% 
                        hc_yAxis(title = list(text = "Statemod (Observed)")) %>%
                        hc_xAxis(title = list(text = "Climate regression simulated")) %>%
                        # hc_annotations(
                        #   list(
                        #     labels =
                        #       list(list(
                        #           point = list(x = 22, y = 22, xAxis = 0, yAxis = 0),
                        #           text = "x: {rsquared}")
                        #           ))
                        #         ) %>% 
                        hc_add_series(
                          data = pred_df, name = "Prediction",
                          type = 'point', hcaes(x = Fitted, y =  `Direct flow shortage normalized`),
                          yAxis = 0, fillOpacity = 0.1) %>% 
                        hc_add_series(
                          data = pred_df, name = "One to one line",
                          type = 'line', 
                          hcaes(x = `Direct flow shortage normalized`, y =  `Direct flow shortage normalized`),
                          yAxis = 0, fillOpacity = 0.1) 
                  
                #  ---- render plotly plot ----
                output$MLRfittedPointPlot <- renderHighchart({
                      obs_fit_hc
                })
             }
          }
  })
```

<!-- ### Admin numbers/dates -->
<!-- ```{r} -->
<!-- htmlOutput("adminDateTable") -->
<!-- ``` -->

```{r context = "server"}
# observeEvent(input$districtMapMLR_click, {
  #  if(!is.null(input$districtMapMLR_click)) {
  #     click <- input$districtMapMLR_click %>%
  #           data.frame() %>%
  #           dplyr::select(lat,lng)
  #   
  #         pt <- sf::st_as_sf(
  #           click,
  #           coords = c("lng", "lat"),
  #           crs = 4326
  #           )
  #         # point intersection w/ polygons
  #         pt_intersect <-  st_filter(shp, pt)
  #   
  #         # ensure  app will not crash if a somewhere other than a shape is clicked and returns no results from point-shape intersection
  #         if(nrow(pt_intersect) == 0) {
  #             NULL
  #            } else {
  #          # } else if(outcome5() == "short_log") {
  #               district_id <- pt_intersect %>%
  #                   rename(district = DISTRICT) %>%
  #                   mutate(district = as.numeric(district))
  #               
  #               # ---- Data wrangling by admin in Shiny ----
  #               by_admin2 <- by_admin %>%
  #                     group_by(year, district) %>%
  #                     # filter(district == 6) %>%
  #                     filter(district == district_id$district) %>%
  #                     mutate(
  #                       year         = as.factor(year),
  #                       admin_number = as.integer(round(admin, 0))
  #                     )
  #               # Join model data w/ admin level supply/demand/short
  #               split_admin <- left_join(
  #                     by_admin2,
  #                     dplyr::select(short_year, year = wyear, district),
  #                     by = c("district", "year")
  #                     ) %>%
  #                 dplyr::filter(!year %in% c(1980, 2013)) %>%
  #                 group_by(district, admin_number) %>%
  #                 summarise(
  #                     demand              = round(mean(demand, na.rm = T), 0)
  #    
  #                 ) %>%
  #                 ungroup() 
  #               
  #               # filter admin date table to only admin numbers that exist
  #               admin_date_table <- admin_dates %>%
  #                 filter(admin_number %in% split_admin$admin_number) %>%
  #                 # mutate(district = "6") %>%
  #                 mutate(district = as.character(district_id$district)) %>%
  #                 left_join(split_admin, by = c("admin_number", "district")) %>% 
  #                 dplyr::select(district, admin_number, date, demand)
  # 
  #               # admin_date_table
  #               admin_tbl <- kableExtra::kable(admin_date_table) %>%
  #                      kableExtra::kable_styling(
  #                       font_size = 12,
  #                       bootstrap_options = c("striped", "hover", "condensed")
  #                     ) 
  #               
  #               output$adminDateTable <- renderText({
  #                     admin_tbl 
  #                 })
  #            }
  #         }
  # })
```


Column {data-width=550}
-------------------------------------
### Timeseries of district-level demand, direct-flow supply, and shortages.
```{r}
# plotly::plotlyOutput("wsTimeseries")
highcharter::highchartOutput("wsTimeseries")
bsTooltip("wsTimeseries", "INSERT TEXT HERE",
                    "bottom", options = list(container = "body"))
```

```{r context = "server"}
observeEvent(input$districtMapMLR_click, {
   if(!is.null(input$districtMapMLR_click)) {
      click <- input$districtMapMLR_click %>%
            data.frame() %>%
            dplyr::select(lat,lng)
    
          pt <- sf::st_as_sf(
            click,
            coords = c("lng", "lat"),
            crs = 4326
            )
          # point intersection w/ polygons
          pt_intersect <-  st_filter(shp, pt)
    
          # ensure  app will not crash if a somewhere other than a shape is clicked and returns no results from point-shape intersection
          if(nrow(pt_intersect) == 0) {
              NULL
             } else {
           # } else if(outcome5() == "short_log") {
                district_id <- pt_intersect %>%
                    rename(district = DISTRICT) %>%
                    mutate(district = as.numeric(district))
                
                
                # ---- Water supply data summarized to the year ----
                ws_data <- by_admin %>%
                    group_by(year, district) %>%
                    mutate(
                        year          = as.factor(year),
                        admin_number  = as.integer(round(admin, 0))
                    ) %>%
                    dplyr::filter(!year %in% c(1980, 2013)) %>%
                    group_by(basin, district, year) %>%
                    summarise(
                        short               = sum(short, na.rm = T),
                        short_dir           = sum(short_dir, na.rm = T),
                        demand              = sum(demand, na.rm = T),
                        supply              = sum(supply, na.rm = T),
                        supply_dir          = sum(supply_dir, na.rm = T)
                      ) %>%
                    mutate(
                        short_norm          = 100*(round(short/demand, 3)),
                        short_dir_norm      = 100*(round(short_dir/demand, 3)),
                        aug_supply          = round((supply - supply_dir), 3),
                        aug_supply_norm     = round(100*(aug_supply/supply), 3),
                        year                = as.factor(year)
                    ) 
                # ---- Water supply data filter to district ----
                # ws_district <- ws_data %>% 
                #     # filter(district == 6)  %>% 
                #     filter(district == district_id$district)  %>% 
                #     mutate(
                #         year          = as.numeric(as.character(year)),
                #         aug_supply2   = aug_supply + supply_dir,
                #         demand2       = demand - aug_supply2
                #     ) %>% 
                #     rename(
                #         "Supply Augmented"    = aug_supply,
                #         "Demand"              = demand2,
                #         "Supply Direct flow"  = supply_dir,
                #         "Year"                = year
                #         ) %>% 
                #     pivot_longer(cols = c("Demand", "Supply Augmented", "Supply Direct flow"))
                # ---- Plot Water Supply/demand/shortage ----
                # stk_plot <- ws_plot(ws_district)
                # 
                # stk_plotly <- plotly::ggplotly(stk_plot, tooltip = c("x")) %>% 
                #                   style(hoverlabel = label) %>% 
                #                   layout(font = font,
                #                          yaxis = list(fixedrange = TRUE),
                #                          xaxis = list(fixedrange = TRUE)) %>% 
                #                   config(displayModeBar = F)
                
                       #  ---- render plotly plot ----
                # output$wsTimeseries <- renderPlotly({
                #       stk_plotly
                # })
                # ---- WIDE district demand, aug supply, supply data ----
                ws_wide <- ws_data %>%
                    # filter(district == 7)  %>%
                    filter(district == district_id$district)  %>%
                    mutate(
                      year        = as.numeric(as.character(year)),
                      aug_supply2 = aug_supply + supply_dir,
                      demand2     = demand - aug_supply2
                    ) %>%
                    rename(
                      "Supply Augmented2" = aug_supply2,
                      "Supply Augmented" = aug_supply,
                      "Demand" = demand,
                      "Demand_diff" = demand2,
                      "Supply Direct flow" = supply_dir) %>% 
                  mutate(across(where(is.numeric), round, 0))
                # ---- HC Dem/sup bar + shortage line ----
                stk_hc <- 
                  highchart() %>%
                      hc_plotOptions(column = list(stacking = 'normal'),
                                     line = list(marker = list(enabled = FALSE), lineWidth = 4)) %>%
                      hc_yAxis(title = list(text = "Water volume (acre feet)"), min = 0) %>% 
                      hc_title(text = "Timeseries of district-level demand, direct-flow supply, and shortages") %>% 
                      # hc_yAxis_multiples(
                      #   list(title = list(text = "Shortage volume (M/Gal)"), min = 0, max = max(ws_wide$short_dir), opposite = TRUE),
                      #   list(title = list(text = "Water volume (M/gal)"), min = 0, max = max(ws_wide$Demand)) ) %>%
                      # hc_add_series( data = ws_wide, name = "Demand", type = 'column', hcaes(x = year, y = Demand_diff), yAxis = 1,
                      # fillOpacity = 0.3) %>%
                    hc_add_series(
                        data = ws_wide, name = "Total shortage",
                        type = 'column', hcaes(x = year, y = short),
                        tooltip = list(pointFormat = "Total shortage: {point.short} AF"),
                        # yAxis = 1, 
                        fillOpacity = 0.3) %>%
                    # hc_add_series(
                    #     data = ws_wide, name = "Direct shortage",
                    #     type = 'column', hcaes(x = year, y = short_dir),
                    #     # yAxis = 1, 
                    #     fillOpacity = 0.3) %>%
                    hc_add_series(
                        data = ws_wide, name = "Augmented supply",
                        type = 'column', hcaes(x = year, y = `Supply Augmented`), 
                        tooltip = list(pointFormat = "Augmented supply: {point.Supply Augmented} AF"),
                        # yAxis = 1, 
                        fillOpacity = 0.3) %>%
                    hc_add_series(
                        data = ws_wide, name = "Direct Flow Supply",
                        type = 'column',  hcaes(x = year, y = `Supply Direct flow`),
                        tooltip = list(pointFormat = "Direct Flow Supply: {point.Supply Direct flow} AF"),
                        # yAxis = 1, 
                        fillOpacity = 0.3) %>%
                    # hc_add_series(data = ws_wide, name = "Total shortage",type = 'line', hcaes(x = year, y = short), yAxis = 0)  %>%
                    # hc_add_series(data = ws_wide, name = "Direct shortage",type = 'line', hcaes(x = year, y = short_dir), yAxis = 0)  %>%
                    hc_add_series(
                        data = ws_wide, name = "Demand",
                        type = 'line', hcaes(x = year, y = Demand),
                        tooltip = list(pointFormat = "Demand: {point.Demand} AF")
                        # yAxis = 1
                        )  %>%
                      hc_xAxis(categories = ws_wide$year) %>%
                      hc_colors(c("#E18686",  "#70BCE2", "#2984B2", "black")) %>%
                      hc_chart(plotBorderWidth = 0.5, plotBorderColor = '#b4b4b4', height = NULL)
                stk_hc
                #  ---- render plotly plot ----
                output$wsTimeseries <- renderHighchart({
                      stk_hc
                })
             }
          }
  })
```

### Best climate predictors of shortages in district
```{r}
highcharter::highchartOutput("predictorTimeseries")
bsTooltip("predictorTimeseries", "INSERT TEXT HERE",
                    "top", options = list(container = "body"))
```

```{r context = "server"}
observeEvent(input$districtMapMLR_click, {
   if(!is.null(input$districtMapMLR_click)) {
      click <- input$districtMapMLR_click %>%
            data.frame() %>%
            dplyr::select(lat,lng)
    
          pt <- sf::st_as_sf(
            click,
            coords = c("lng", "lat"),
            crs = 4326
            )
          # point intersection w/ polygons
          pt_intersect <-  st_filter(shp, pt)
    
          # ensure  app will not crash if a somewhere other than a shape is clicked and returns no results from point-shape intersection
          if(nrow(pt_intersect) == 0) {
              NULL
             } else {
           # } else if(outcome5() == "short_log") {
                district_id <- pt_intersect %>%
                    rename(district = DISTRICT) %>%
                    mutate(district = as.numeric(district))
                
                # ---- Summarize data for MLR ----
                mlr_data <- by_admin %>%
                  group_by(year, district) %>%
                  mutate(
                    year          = as.factor(year),
                    admin_number  = as.integer(round(admin, 0))
                  ) %>%
                  dplyr::filter(!year %in% c(1980, 2013)) %>%
                  group_by(basin, district, year) %>%
                  summarise(
                      short               = sum(short, na.rm = T),
                      short_dir           = sum(short_dir, na.rm = T),
                      demand              = sum(demand, na.rm = T),
                      supply              = sum(supply, na.rm = T),
                      supply_dir          = sum(supply_dir, na.rm = T)
                  ) %>%
                  mutate(
                      short_norm          = 100*(round(short/demand, 3)),
                      short_dir_norm      = 100*(round(short_dir/demand, 3)),
                      aug_supply          = round((supply - supply_dir), 3),
                      aug_supply_norm     = round(100*(aug_supply/supply), 3),
                      year                = as.factor(year)
                  )
                
                ## ------ Join model data w/ admin level supply/demand/short -------
                mlr_district <- left_join(
                      mlr_data,
                      dplyr::select(short_year, year = wyear, district, 20:41),
                      by = c("district", "year")
                ) %>%
                  # filter(district == 6) %>%
                  filter(district == district_id$district) %>%
                  dplyr::filter(!year %in% c(1980, 2013)) %>%
                  # group_by(basin, district, water_right, year) %>%
                  group_by(basin, district, year) %>%
                  summarise(
                      short               = sum(short, na.rm = T),
                      short_dir           = sum(short_dir, na.rm = T),
                      demand              = sum(demand, na.rm = T),
                      supply              = sum(supply, na.rm = T),
                      supply_dir          = sum(supply_dir, na.rm = T),
                      af_total            = mean(af_total, na.rm = T),
                      swe_max             = mean(swe_max, na.rm = T),
                      prcp                = mean(prcp, na.rm = T),
                      prcp_norm           = mean(prcp_norm, na.rm = T),
                      pdsi                = mean(pdsi, na.rm = T),
                      pdsi_gridmet        = mean(pdsi_gridmet, na.rm = T),
                      eddi1               = mean(eddi1, na.rm = T),
                      eddi3               = mean(eddi3, na.rm = T),
                      eddi6               = mean(eddi6, na.rm = T),
                      eddi12              = mean(eddi12, na.rm = T),
                      spi1                = mean(spi1, na.rm = T),
                      spi3                = mean(spi3, na.rm = T),
                      spi6                = mean(spi6, na.rm = T),
                      spi9                = mean(spi9, na.rm = T),
                      spi12               = mean(spi12, na.rm = T),
                      tavg                = mean(tavg, na.rm = T),
                      aet                 = mean(aet, na.rm = T),
                      pet                 = mean(pet, na.rm = T),
                      soilm               = mean(soilm, na.rm = T)
                  ) %>%
                  mutate(
                      short_norm          = 100*(round(short/demand, 3)),
                      short_dir_norm      = 100*(round(short_dir/demand, 3)),
                      aug_supply          = round((supply - supply_dir), 3),
                      aug_supply_norm     = round(100*(aug_supply/supply), 3),
                      year                = as.factor(year)
                  ) %>%
                  ungroup()
                
                # ---- Prep data for model ----
                mod_df <- mlr_district %>%
                  dplyr::select(short_dir_norm, 10:11, 13:27)
                
                # ---- MLR Model + stepwise regression ----
                lm_vfit <- lm(short_dir_norm~., data = mod_df) %>%
                              # rm_collinearity(vif_thresh = 3.5) %>%
                              ols_step_forward_p()
                
                # ---- Select predictors from data ----
                ws_predictors <- mlr_district %>%
                    ungroup() %>%
                    dplyr::select(year, lm_vfit$predictors[1:2]) %>%
                    mutate(across(where(is.numeric), round, 2)) %>% 
                    mutate(year = as.numeric(as.character(year)))
                
                # Fix names for axis, labels, titles
                pred_names <- names(rename_all(ws_predictors, recode,
                                        swe_max           = "SWE maximum (in)",
                                        prcp              = "Precipitation (mm)",
                                        pdsi              = "PDSI",
                                        pdsi_gridmet      = "PDSI (gridMET)",
                                        eddi1             = "EDDI 1 month",
                                        eddi3             = "EDDI 3 month",
                                        eddi6             = "EDDI 6 month",
                                        eddi12            = "EDDI 12 month",
                                        spi1              = "SPI 1 month",
                                        spi3              = "SPI 3 month",
                                        spi6              = "SPI 6 month",
                                        spi9              = "SPI 9 month",
                                        spi12             = "SPI 12 month",
                                        tavg              = "Average temperature (C)",
                                        aet               = "Actual evapotranspiration (mm)",
                                        pet               = "Potential Evapotranspiration (mm)",
                                        soilm             = "Soil moisture (mm)")
                                    )
          
                # ---- Predictors highchart ----
                pred_hc <- 
                 highchart() %>%
                      hc_plotOptions(column = list(stacking = 'normal'),
                                     line = list(marker = list(enabled = FALSE), lineWidth = 4)) %>%
                      hc_title(text = "Best climate predictors of shortages in district") %>% 
                      hc_yAxis(title = list(text = "Water volume (acre feet)"), min = 0) %>%
                      hc_yAxis_multiples(
                        list(title = list(
                                text = pred_names[2],
                                style = list(fontWeight = "bold",  fontSize = '1.2em')
                                ),
                             labels = list(style = list(fontSize =  '1.2em')),
                                top = "0%",
                                height = "50%" 
                             ),
                        list(title = list(
                                text   = pred_names[3],
                                style  = list(fontWeight = "bold",  fontSize = '1.2em')),
                              labels = list(style = list(fontSize =  '1.2em')),
                                top      = "50%", 
                                height = "50%",
                                opposite = TRUE)
                        ) %>% 
                      hc_xAxis(labels = list(style = list(fontSize =  '1.2em'))
                               ) %>% 
                      hc_add_series(
                            data = ws_predictors, 
                            name = pred_names[2],
                            type = 'line',
                            hcaes(x = year,  y = !!lm_vfit$predictors[1]),
                            yAxis = 0,
                            fillOpacity = 0.1) %>%
                      hc_add_series(
                            data = ws_predictors,
                            name = pred_names[3],
                            type = 'line', hcaes(x = year, y = !!lm_vfit$predictors[2]),
                            yAxis = 1, fillOpacity = 0.1) %>%
                      hc_xAxis(categories = ws_predictors$year) %>%
                      hc_colors(c("darkblue",  "darkred")) %>%
                      hc_chart(plotBorderWidth = 0.5, plotBorderColor = '#b4b4b4', height = NULL)
                
                #  ---- render predictors HC plot ----
                output$predictorTimeseries <- renderHighchart({
                      pred_hc
                })
             }
          }
  })
```



Univariate linear regression 
=====================================
Inputs {.sidebar}
----------------------------------------------------

***

### **How to:**

#### **1.** 

#### **2.** 

#### **3.** 

### **Model inputs:**

*** 

<br>

##### **Dependent variables**
```{r}
selectInput(
  "depVarInput",
  label = NULL,
  # selected = "short_norm",
    # choices = as.list(outcome_lst$outcome_variable)
  selected = "Total shortage",
  choices = impacts_lst
)
bsTooltip("depVarInput", "INSERT TEXT HERE",
                    "right", options = list(container = "body"))
```

<br>
<br>

##### **Drought indicators**
```{r}
selectInput(
  "climVarInput",
  label = NULL,
  # selected = "prcp",
  # choices = as.list(indepent_lst$independent_variable)
  selected = "Precipitation",
  choices = indicator_lst
  # choices = as.list(indepent_lst2$independent_variable)
  )
bsTooltip("climVarInput", "INSERT TEXT HERE",
                    "right", options = list(container = "body"))
actionButton(
  "climVarHelpButton",
  # label = "Help",
  # class = "btn-primary btn-lg",
  icon("question")
  )

observeEvent(input$climVarHelpButton, {
  shinyalert(title = "Hey",
             showCancelButton = TRUE,
             closeOnClickOutside = TRUE,
             text = "Info on Drought indicators")
})

```

<br>

####
```{r}
actionButton(
  "submitButton",
  label = "Run model",
  class = "btn-primary btn-lg",
  icon("play")
  )
bsTooltip("submitButton", "INSERT TEXT HERE",
                    "right", options = list(container = "body"))
```

<!-- ###  -->
<!-- ```{r} -->
<!-- actionButton( -->
<!--   "modelRunHelpButton", -->
<!--   # label = "Help", -->
<!--   # class = "btn-primary btn-lg", -->
<!--   icon("question") -->
<!--   ) -->

<!-- observeEvent(input$modelRunHelpButton, { -->
<!--   shinyalert(title = "Hey", -->
<!--              closeOnClickOutside = TRUE, -->
<!--              showCancelButton = TRUE, -->
<!--              text = "Press this button to run the model") -->
<!-- }) -->
<!-- ``` -->

***



```{r context = "server"}
# Dependent variable input reactive
depVar <- reactive({
  input$depVarInput
})

# climate variable input reactive
climVar <- reactive({
  input$climVarInput
})
```

Column {data-width=250}
-----------------------------------------------------------------------

### 
```{r}
valueBoxOutput("districtBoxLM")
```

### Water districts
```{r}
leafletOutput("districtMapLM")
bsTooltip("districtMapLM", "INSERT TEXT HERE",
                    "bottom", options = list(container = "body"))
```


```{r context="server"}
# render district value box at start
output$districtBoxLM <- renderValueBox(
                    valueBox(
                      value = "District", 
                      color = "success"
                  )
                )

# Clicking on map 1 outputs Value boxes on both pages + catchment polygons + Dat table + success panel
observeEvent(input$districtMapLM_click, {
   if(!is.null(input$districtMapLM_click)) {
      click <- input$districtMapLM_click %>%
        data.frame() %>%
        dplyr::select(lat,lng)
      print(click)

      pt <- sf::st_as_sf(
        click,
        coords = c("lng", "lat"),
        crs = 4326
        )

      # point intersection w/ polygons
      pt_intersect <-  st_filter(shp, pt)

      # ensure  app will not crash if a somewhere other than a shape is clicked and returns no results from point-shape intersection
       if(nrow(pt_intersect) == 0) {
          NULL
       } else {
          district_id <- pt_intersect %>%
              rename(district = DISTRICT) %>%
              mutate(district = as.numeric(district))

          # District number value box
          output$districtBoxLM <- renderValueBox(
            valueBox(
              value = paste0("District ", district_id$district),
              color = "success"
              )
            )
          
          pal <- colorNumeric("YlOrRd", domain = shp$variance_rsq, n = 21)
          
          bb = shp %>%
              st_bbox() %>%
              st_as_sfc() %>%
              st_transform(4326) %>%
              st_as_sf()
          # Map 2 fly to bounds
          bounds <- st_bbox(bb) %>%
              st_as_sfc() %>%
              st_buffer(0.009) %>%
              st_bbox() %>%
              as.vector()
       
          leafletProxy("districtMapLM") %>%
              clearMarkers() %>%
              clearShapes() %>%
              addMarkers(data = pt) %>%
              addPolygons(
                    data = shp,
                    fillColor = 'white',
                    fillOpacity = 0.5,
                    col = "black",
                    weight = 3,
                    label = ~DISTRICT,
                    labelOptions = labelOptions(
                        noHide = F,
                        # direction = 'center',
                        # textOnly = F)
                        style = list(
                          "color" = "black",
                          "font-weight" = "1000")
                      )
                  ) %>%
              addScaleBar("bottomleft") %>%
              addMeasure(
                position = "bottomleft",
                  primaryLengthUnit = "feet",
                  primaryAreaUnit = "sqmiles",
                  activeColor = "red",
                  completedColor = "green" ) %>%
            leafem::addMouseCoordinates() %>% 
            flyToBounds(bounds[1], bounds[2], bounds[3], bounds[4])
              # addPolygons(
              #       data = shp,
              #       color = "black",
              #       fillOpacity = 0.8,
              #       fillColor = ~pal(variance_rsq),
              #       weight = 2,
              #       label = ~DISTRICT,
              #       labelOptions = labelOptions(
              #         noHide = F,
              #         # direction = 'center',
              #         # textOnly = F)
              #         style = list(
              #           "color" = "black",
              #           "font-weight" = "1000")
              #     )
             
              # flyToBounds(bounds[1], bounds[2], bounds[3], bounds[4])
       }
    }
})
```


```{r context="server"}
# render district value box at start
# output$districtBoxLM <- renderValueBox(
#                     valueBox(
#                       value = "District", 
#                       color = "success"
#                   )
#                 )

# Clicking on map 1 outputs Value boxes on both pages + catchment polygons + Dat table + success panel
observeEvent(input$districtMapLM_click, {
   if(!is.null(input$districtMapLM_click)) {
      click <- input$districtMapLM_click %>%
        data.frame() %>%
        dplyr::select(lat,lng)
      print(click)

      pt <- sf::st_as_sf(
        click,
        coords = c("lng", "lat"),
        crs = 4326
        )

      # point intersection w/ polygons
      pt_intersect <-  st_filter(shp, pt)

      # ensure  app will not crash if a somewhere other than a shape is clicked and returns no results from point-shape intersection
       if(nrow(pt_intersect) == 0) {
          NULL
       } else {
          district_id <- pt_intersect %>%
              rename(district = DISTRICT) %>%
              mutate(district = as.numeric(district))
          
          # District number value box
          output$districtBoxLM <- renderValueBox(
            valueBox(
              value = paste0("District ", district_id$district),
              color = "success"
              )
          )
          # output$splitBoxLM <- renderValueBox(
          #   valueBox(
          #     value   = paste0(splitRightsLM()),
          #     caption = "Priority date",
          #     color   = "success"
          #     )
          #   )
          bb = shp %>%
              st_bbox() %>%
              st_as_sfc() %>%
              st_transform(4326) %>%
              st_as_sf()
          # Map 2 fly to bounds
          bounds <- st_bbox(bb) %>%
              st_as_sfc() %>%
              st_buffer(0.009) %>%
              st_bbox() %>%
              as.vector()
          
          pal <- colorNumeric("YlOrRd", domain = shp$variance_rsq, n = 21)
          
          leafletProxy("districtMapLM") %>%
              clearMarkers() %>%
              clearShapes() %>%
              addMarkers(data = pt) %>%
              addPolygons(
                    data = shp,
                    fillColor = 'white',
                    fillOpacity = 0.5,
                    col = "black",
                    weight = 3,
                    label = ~DISTRICT,
                    labelOptions = labelOptions(
                        noHide = F,
                        # direction = 'center',
                        # textOnly = F)
                        style = list(
                          "color" = "black",
                          "font-weight" = "1000")
                      )
                  ) %>%
              addScaleBar("bottomleft") %>%
              addMeasure(
                position = "bottomleft",
                  primaryLengthUnit = "feet",
                  primaryAreaUnit = "sqmiles",
                  activeColor = "red",
                  completedColor = "green" ) %>%
            leafem::addMouseCoordinates() %>% 
            flyToBounds(bounds[1], bounds[2], bounds[3], bounds[4])
              # addPolygons(
              #         data = shp,
              #         color = "black",
              #         fillOpacity = 0.8,
              #         fillColor = ~pal(variance_rsq),
              #         weight = 2,
              #         label = ~DISTRICT,
              #         labelOptions = labelOptions(
              #           noHide = F,
              #           # direction = 'center',
              #           # textOnly = F)
              #           style = list(
              #             "color" = "black",
              #             "font-weight" = "1000")
              #           )
              #         ) 
              # flyToBounds(bounds[1], bounds[2], bounds[3], bounds[4])
       }
    }
})

# ---- PRIORITY DATE ----
# output$splitBoxLM <- renderValueBox(
#             valueBox(
#               value = "Priority date",
#               color   = "success"
#               )
#             )

# splitRightsLM <- eventReactive(input$submitButton, {
#    click <- input$districtMapLM_click %>%
#         data.frame() %>%
#         dplyr::select(lat,lng)
# 
#       pt <- sf::st_as_sf(
#         click,
#         coords = c("lng", "lat"),
#         crs = 4326
#         )
# 
#       # point intersection w/ polygons
#       pt_intersect <-  st_filter(shp, pt)
# 
#       # ensure  app will not crash if a somewhere other than a shape is clicked and returns no results from point-shape intersection
#       if(nrow(pt_intersect) == 0) {
#           NULL
#          } else {
#             district_id <- pt_intersect %>%
#                 rename(district = DISTRICT) %>%
#                 mutate(district = as.numeric(district))
#             
#             # adm_date <- admin_dates %>% 
#             #    filter(admin_number == adminNum())
#              # filter(admin_number == 4900)
#             
#             # paste0(adminNum(), ": ", adm_date$date)
#             breaks2 <- breaks %>% 
#                     # filter(district == 7) %>%
#                     filter(district == district_id$district) %>%
#                     ungroup() %>% 
#                     filter(demand_cuml_tot == split) %>% 
#                     dplyr::select(admin_number) %>% 
#                     head(1)
#             adm_date <- admin_dates %>%
#                  filter(admin_number == breaks2[[1]])
#             paste0(breaks2$admin_number, ": ", adm_date$date)
# 
#          }
# })


# Water rights admin number split value box
# output$splitBoxLM <- renderValueBox(
#         valueBox(
#           value   = paste0(splitRightsLM()),
#           caption = "Priority date",
#           color   = "success"
#           )
#         )
```

<!-- ### **Priority date** -->
<!-- ```{r} -->
<!-- valueBoxOutput("splitBoxLM") -->
<!-- ``` -->

```{r context = "server"}
modelSummaryData <- eventReactive(input$submitButton, {
   # if(!is.null(input$districtMapLM_click)) {
    click <- input$districtMapLM_click %>%
            data.frame() %>%
            dplyr::select(lat,lng)

          pt <- sf::st_as_sf(
            click,
            coords = c("lng", "lat"),
            crs = 4326
            )
          # point intersection w/ polygons
          pt_intersect <-  st_filter(shp, pt)

          # ensure  app will not crash if a somewhere other than a shape is clicked and returns no results from point-shape intersection
          if(nrow(pt_intersect) == 0) {
              NULL
             } else {
                district_id <- pt_intersect %>%
                    rename(district = DISTRICT) %>%
                    mutate(district = as.numeric(district))
                 # ---- Water supply data summarized to the year ----
                ws_data <- by_admin %>%
                  group_by(year, district) %>%
                  mutate(
                      year          = as.factor(year),
                      admin_number  = as.integer(round(admin, 0))
                  ) %>%
                  dplyr::filter(!year %in% c(1980, 2013)) %>%
                  group_by(basin, district, year) %>%
                  summarise(
                      short               = sum(short, na.rm = T),
                      short_dir           = sum(short_dir, na.rm = T),
                      demand              = sum(demand, na.rm = T),
                      supply              = sum(supply, na.rm = T),
                      supply_dir          = sum(supply_dir, na.rm = T)
                  ) %>%
                  mutate(
                      short_norm          = 100*(round(short/demand, 3)),
                      short_dir_norm      = 100*(round(short_dir/demand, 3)),
                      aug_supply          = round((supply - supply_dir), 3),
                      aug_supply_norm     = round(100*(aug_supply/supply), 3),
                      year                = as.factor(year)
                  )

                # ---- Join indicators & impacts data, summarize to district level ----
                by_district <- left_join(
                      ws_data,
                      dplyr::select(short_year, year = wyear, district, 20:41),
                      by = c("district", "year")
                ) %>%
                  # filter(district == 6) %>%
                  filter(district == district_id$district) %>%
                  dplyr::filter(!year %in% c(1980, 2013)) %>%
                  group_by(basin, district, year) %>%
                  summarise(
                        short               = sum(short, na.rm = T),
                        short_dir           = sum(short_dir, na.rm = T),
                        demand              = sum(demand, na.rm = T),
                        supply              = sum(supply, na.rm = T),
                        supply_dir          = sum(supply_dir, na.rm = T),
                        af_total            = mean(af_total, na.rm = T),
                        swe_max             = mean(swe_max, na.rm = T),
                        prcp                = mean(prcp, na.rm = T),
                        prcp_norm           = mean(prcp_norm, na.rm = T),
                        pdsi                = mean(pdsi, na.rm = T),
                        pdsi_gridmet        = mean(pdsi_gridmet, na.rm = T),
                        eddi1               = mean(eddi1, na.rm = T),
                        eddi3               = mean(eddi3, na.rm = T),
                        eddi6               = mean(eddi6, na.rm = T),
                        eddi12              = mean(eddi12, na.rm = T),
                        spi1                = mean(spi1, na.rm = T),
                        spi3                = mean(spi3, na.rm = T),
                        spi6                = mean(spi6, na.rm = T),
                        spi9                = mean(spi9, na.rm = T),
                        spi12               = mean(spi12, na.rm = T),
                        tavg                = mean(tavg, na.rm = T),
                        aet                 = mean(aet, na.rm = T),
                        pet                 = mean(pet, na.rm = T),
                        soilm               = mean(soilm, na.rm = T)
                  ) %>%
                  mutate(
                        short_norm          = 100*(round(short/demand, 3)),
                        short_dir_norm      = 100*(round(short_dir/demand, 3)),
                        aug_supply          = round((supply - supply_dir), 3),
                        aug_supply_norm     = round(100*(aug_supply/supply), 3),
                        year                = as.factor(year)
                  )
                # ---- log transform data ----
                trans_log <- by_district %>%
                      mutate(
                        short               = log10(short),
                        short_dir           = log10(short_dir),
                        short_norm          = log10(short_norm),
                        short_dir_norm      = log10(short_dir_norm),
                        aug_supply          = log10(aug_supply),
                        aug_supply_norm     = log10(aug_supply_norm),
                        supply              = log10(supply),
                        supply_dir          = log10(supply_dir),
                        demand              = log10(demand),
                        af_total            = log10(af_total)
                      )

                  # replace Infinite w/ 0
                is.na(trans_log) <- sapply(trans_log, is.infinite)
                trans_log[is.na(trans_log)] <- 0

                trans_log <- trans_log %>%
                      # dplyr::select(short_dir_norm, prcp)
                      dplyr::select(depVar(), climVar())

                    # ---- Linear regression run, nested dataframe ----
                lm_run <- trans_log %>%
                        group_by(district) %>%
                        nest(-district) %>%
                        mutate(
                          fit       = map(data,
                                           # ~lm(short_dir_norm~prcp, data = .)),
                                           ~lm(as.formula(
                                             paste(depVar()," ~ ", climVar())
                                           ),
                                           data = .)),
                          results   = map(fit, augment),
                          tidied    = map(fit, tidy),
                          metrics   = map(fit, glance)
                        )

                 indicator_label <- names(indicator_lst[grep(pattern = paste0("^", climVar(), "$"), indicator_lst)])
                 impact_label <- names(impacts_lst[grep(pattern = paste0("^", depVar(), "$"), impacts_lst)])
                 # indicator_label <- names(indicator_lst[grep(pattern = paste0("prcp"), indicator_lst)])
                 # impact_label <- names(impacts_lst[grep(pattern = paste0("short_dir_norm"), impacts_lst)])
      
                 tbl_data <- lm_run %>%
                        unnest(c(metrics)) %>%
                        dplyr::select(district, tidied, r_squared = r.squared, p_value = p.value) %>%
                        unnest(c(tidied))  %>%
                        ungroup() %>%
                        dplyr::select(term, coefficient = estimate, r_squared, p_value) %>%
                        mutate(
                            coefficient   = round(coefficient, 3),
                            r_squared     = round(r_squared,3),
                            p_value       = round(p_value, 5)
                               ) %>%
                        # mutate(across(where(is.numeric), round, 3)) %>%
                        # mutate(across(where(is.numeric), as.character)) %>%
                        rename(
                            # District      = district,
                            Term          = term,
                            Coefficient   = coefficient,
                            "R Squared"   = r_squared,
                            "p-value"     = p_value
                        )
                  tbl_coeff <- tbl_data %>% 
                        filter(Term != "(Intercept)") %>% 
                        mutate(
                           Term = indicator_label
                           )
                   
                  tbl_int <- tbl_data %>% 
                        filter(Term == "(Intercept)") 
  
                  tbl_clean <- bind_rows(tbl_int, tbl_coeff)
                   
                  customGreen0 = "#DeF7E9"
                  customGreen = "#71CA97"
                  customRed = "#ff7f7f"
                  improvement_formatter <-
                        formatter("span",
                                  style = x ~ style(
                                    font.weight = "bold",
                                    color = ifelse(x > 0, customGreen, ifelse(x < 0, customRed, "black"))
                                    )
                                  )
                  format_tbl <-
                    formattable(tbl_clean,
                                align = c("l",rep("r", NCOL(tbl_data) - 1)),
                                list(
                                  `Term` = formatter("span", style = ~ style(color = "black", font.weight = "bold")),
                                  `Coefficient` = improvement_formatter,
                                  area(col = 3:4) ~ color_tile("#EAECEE", "#EAECEE"))
                                )
                  format_tbl
}})

output$modelSummary <- renderFormattable({
                  modelSummaryData()
                  })
```

### Model summary {data-height=75}
```{r}
formattable::formattableOutput("modelSummary")
```

Column {data-width=550}
-------------------------------------
### Model
```{r}
# plotly::plotlyOutput("wsTimeseries")
highcharter::highchartOutput("lmPlot")
bsTooltip("lmPlot", "INSERT TEXT HERE",
                    "top", options = list(container = "body"))
# verbatimTextOutput("lmPlot")
```

```{r context = "server"}
lmModelData <- eventReactive(input$submitButton, {
   # if(!is.null(input$districtMapLM_click)) {
      click <- input$districtMapLM_click %>%
            data.frame() %>%
            dplyr::select(lat,lng)

          pt <- sf::st_as_sf(
            click,
            coords = c("lng", "lat"),
            crs = 4326
            )
          # point intersection w/ polygons
          pt_intersect <-  st_filter(shp, pt)

          # ensure  app will not crash if a somewhere other than a shape is clicked and returns no results from point-shape intersection
          if(nrow(pt_intersect) == 0) {
              NULL
             } else {
                district_id <- pt_intersect %>%
                    rename(district = DISTRICT) %>%
                    mutate(district = as.numeric(district))
                # ---- Water supply data summarized to the year ----
                ws_data <- by_admin %>%
                  group_by(year, district) %>%
                  mutate(
                      year          = as.factor(year),
                      admin_number  = as.integer(round(admin, 0))
                  ) %>%
                  dplyr::filter(!year %in% c(1980, 2013)) %>%
                  group_by(basin, district, year) %>%
                  summarise(
                      short               = sum(short, na.rm = T),
                      short_dir           = sum(short_dir, na.rm = T),
                      demand              = sum(demand, na.rm = T),
                      supply              = sum(supply, na.rm = T),
                      supply_dir          = sum(supply_dir, na.rm = T)
                  ) %>%
                  mutate(
                      short_norm          = 100*(round(short/demand, 3)),
                      short_dir_norm      = 100*(round(short_dir/demand, 3)),
                      aug_supply          = round((supply - supply_dir), 3),
                      aug_supply_norm     = round(100*(aug_supply/supply), 3),
                      year                = as.factor(year)
                  )
#                 
#                 # ---- Join indicators & impacts data, summarize to district level ----
                by_district <- left_join(
                        ws_data,
                        dplyr::select(short_year, year = wyear, district, 20:41),
                        by = c("district", "year")
                        ) %>%
                  # filter(district == 6) %>%
                  filter(district == district_id$district) %>%
                  dplyr::filter(!year %in% c(1980, 2013)) %>%
                  group_by(basin, district, year) %>%
                  summarise(
                        short               = sum(short, na.rm = T),
                        short_dir           = sum(short_dir, na.rm = T),
                        demand              = sum(demand, na.rm = T),
                        supply              = sum(supply, na.rm = T),
                        supply_dir          = sum(supply_dir, na.rm = T),
                        af_total            = mean(af_total, na.rm = T),
                        swe_max             = mean(swe_max, na.rm = T),
                        prcp                = mean(prcp, na.rm = T),
                        prcp_norm           = mean(prcp_norm, na.rm = T),
                        pdsi                = mean(pdsi, na.rm = T),
                        pdsi_gridmet        = mean(pdsi_gridmet, na.rm = T),
                        eddi1               = mean(eddi1, na.rm = T),
                        eddi3               = mean(eddi3, na.rm = T),
                        eddi6               = mean(eddi6, na.rm = T),
                        eddi12              = mean(eddi12, na.rm = T),
                        spi1                = mean(spi1, na.rm = T),
                        spi3                = mean(spi3, na.rm = T),
                        spi6                = mean(spi6, na.rm = T),
                        spi9                = mean(spi9, na.rm = T),
                        spi12               = mean(spi12, na.rm = T),
                        tavg                = mean(tavg, na.rm = T),
                        aet                 = mean(aet, na.rm = T),
                        pet                 = mean(pet, na.rm = T),
                        soilm               = mean(soilm, na.rm = T)
                  ) %>%
                  mutate(
                        short_norm          = 100*(round(short/demand, 3)),
                        short_dir_norm      = 100*(round(short_dir/demand, 3)),
                        aug_supply          = round((supply - supply_dir), 3),
                        aug_supply_norm     = round(100*(aug_supply/supply), 3),
                        year                = as.factor(year))
                # --- UNCLEAN NAME SUMMARIZE ----
#                   summarise(
#                       "Total shortage"               = sum(short, na.rm = T),
#                             "Direct shortage"        = sum(short_dir, na.rm = T),
#                              demand   = sum(demand, na.rm = T),
#                                 supply   = sum(supply, na.rm = T),
#                                 supply_dir = sum(supply_dir, na.rm = T),
#                            "Natural flows"     =mean(af_total, na.rm = T),
#                                   "SWE maximum"=   mean(swe_max, na.rm = T), 
#                                    "Precipitation"=       mean(prcp, na.rm = T), 
#                                prcp_norm   =mean(prcp_norm, na.rm = T),
#                                 "PDSI"=      mean(pdsi, na.rm = T), 
#                                "PDSI (gridMET)"=    mean(pdsi_gridmet, na.rm = T), 
#                                 "EDDI 1 month"=    mean(eddi1, na.rm = T), 
#                                 "EDDI 3 month"=       mean(eddi3, na.rm = T), 
#                                    "EDDI 6 month"=      mean(eddi6, na.rm = T), 
#                                   "EDDI 12 month"=    mean(eddi12, na.rm = T), 
#                                    "SPI 1 month"   = mean(spi1, na.rm = T),
#                                     "SPI 3 month"  = mean(spi3, na.rm = T),
#                                    "SPI 6 month"   = mean(spi6, na.rm = T),
#                                    "SPI 9 month" = mean(spi9, na.rm = T),
#                                     "SPI 12 month" = mean(spi12, na.rm = T),
#                                        "Average temperature (C)" = mean(tavg, na.rm = T), 
#                                     "Actual evapotranspiration"   = mean(aet, na.rm = T),
#                                   "Potential Evapotranspiration"  = mean(pet, na.rm = T),
#                                  "Soil moisture"  = mean(soilm, na.rm = T)
#                   ) %>% 
#                   mutate(
#                         "Normalized total shortage"          = 100*(round(`Total shortage`/demand, 3)),
#                         "Normalized direct shortage"      = 100*(round(`Direct shortage`/demand, 3)),
#                          # "Total shortage"               = log10(`Total shortage`),
#                          #    "Direct shortage"        = log10(`Direct shortage`),
#                         # "Normalized total shortage"          = log10(100*(round(`Total shortage`/demand, 3))),
#                         # "Normalized direct shortage"      = log10(100*(round(`Direct shortage`/demand, 3))),
#                         #  "Total shortage"               = log10(`Total shortage`),
#                         #     "Direct shortage"        = log10(`Direct shortage`),
#                         # aug_supply          = round((supply - supply_dir), 3),
#                         # aug_supply_norm     = round(100*(aug_supply/supply), 3), 
#                         year                = as.factor(year))
                # ------
                
                                     # Fix names for axis, labels, titles
                # names(by_district) <- names(rename_all(by_district, recode,
                #                                short             = "Total shortage",
                #                                short_dir         = "Direct shortage",
                #                                short_norm        = "Normalized total shortage",
                #                                short_dir_norm    = "Normalized direct shortage",
                #                                af_total          = "Natural flows",
                #                                swe_max           = "SWE maximum",
                #                                prcp              = "Precipitation",
                #                                pdsi              = "PDSI",
                #                                pdsi_gridmet      = "PDSI (gridMET)",
                #                                eddi1             = "EDDI 1 month",
                #                                eddi3             = "EDDI 3 month",
                #                                eddi6             = "EDDI 6 month",
                #                                eddi12            = "EDDI 12 month",
                #                                spi1              = "SPI 1 month",
                #                                spi3              = "SPI 3 month",
                #                                spi6              = "SPI 6 month",
                #                                spi9              = "SPI 9 month",
                #                                spi12             = "SPI 12 month",
                #                                tavg              = "Average temperature (C)",
                #                                aet               = "Actual evapotranspiration",
                #                                pet               = "Potential Evapotranspiration",
                #                                soilm             = "Soil moisture")
                # )
                
                #  # ---- log transform data ----
                # trans_log <- by_district %>%
                #       mutate(
                #         `Total shortage`                  = log10(`Total shortage`),
                #         `Direct shortage`                 = log10(`Direct shortage`),
                #         `Normalized total shortage`       = log10(`Normalized total shortage`),
                #         `Normalized direct shortage`      = log10(`Normalized direct shortage`)
                #         # aug_supply          = log10(aug_supply),
                #         # aug_supply_norm     = log10(aug_supply_norm),
                #         # supply              = log10(supply),
                #         # supply_dir          = log10(supply_dir),
                #         # demand              = log10(demand)
                #       )
              
                # # ---- log transform data ----
                trans_log <- by_district %>%
                      mutate(
                        short               = log10(short),
                        short_dir           = log10(short_dir),
                        short_norm          = log10(short_norm),
                        short_dir_norm      = log10(short_dir_norm),
                        aug_supply          = log10(aug_supply),
                        aug_supply_norm     = log10(aug_supply_norm),
                        supply              = log10(supply),
                        supply_dir          = log10(supply_dir),
                        demand              = log10(demand),
                        af_total            = log10(af_total)
                      )
                
              #     # replace Infinite w/ 0
                  is.na(trans_log) <- sapply(trans_log, is.infinite)
                  trans_log[is.na(trans_log)] <- 0
              #     
              #     print(paste0("hi2"))
              #     print(paste0(depVar()))
                  trans_log <- trans_log %>%
                      # dplyr::select(short_dir_norm, prcp)
                      dplyr::select(depVar(), climVar())
              # print(as.formula(paste0(paste0(depVar())," ~ ", paste0(climVar()))))
                  # 
                  # #   # ---- Linear regression run, nested dataframe ----
                  lm_run <- trans_log %>%
                        group_by(district) %>%
                        nest(-district) %>%
                        mutate(
                          fit       = map(data,
                                           # ~lm(short_dir_norm~prcp, data = .)),
                                           ~lm(as.formula(
                                             paste0(depVar()," ~ ", climVar())
                                           ),
                                           data = .)),
                          results   = map(fit, augment),
                          tidied    = map(fit, tidy),
                          metrics   = map(fit, glance)
                        ) %>%
                        unnest(c(4)) %>%
                        # dplyr::select(district, short_dir_norm, prcp, Fitted = .fitted) %>%
                    
                       # dplyr::select(district, `Normalized direct shortage`, `Precipitation`, Fitted = .fitted)
                        dplyr::select(district, depVar(), climVar(), Fitted = .fitted) %>%
                        setNames(c("district", "Dependent", "Independent", "Fitted"))
                  # output$LMplot <- renderText({
                  #   paste0(trans_log)
                  # })
                    # # Extract fitted values and back transform Logs
                    mod_vals <- lm_run %>%
                        ungroup() %>%
                        # mutate(
                        #     # `Normalized direct shortage`          = 10^lm_run$`Normalized direct shortage`,
                        #     depVar()                              = 10^lm_run$depVar(),
                        #     Fitted                                = 10^lm_run$Fitted
                        # ) %>%
                        mutate(
                            Dependent          = 10^lm_run$Dependent,
                            Fitted             = 10^lm_run$Fitted
                        ) %>%
                        mutate(across(where(is.numeric), round, 1))
                    # 
                    # 
                    # # names(mod_vals) <- janitor::make_clean_names(names(mod_vals), "title")
                    # # density_vals <- density(mod_vals$`Normalized direct shortage`)
                    # density_vals <- density(mod_vals$!!depVar())
                    # density_yaxis <- density_vals$y

                    density_vals <- density(mod_vals$Independent)
                    density_yaxis <- density_vals$y
                    
                    indicator_label <- names(indicator_lst[grep(pattern = paste0("^", climVar(), "$"), indicator_lst)])
                    impact_label <- names(impacts_lst[grep(pattern = paste0("^", depVar(), "$"), impacts_lst)])
                    # indicator_label <- names(indicator_lst[grep(pattern = paste0("prcp"), indicator_lst)])
                    # impact_label <- names(impacts_lst[grep(pattern = paste0("short_dir_norm"), impacts_lst)])
                    
                    lm_hc <-
                      highchart() %>%
                          hc_plotOptions(line = list(marker = list(enabled = FALSE, symbol = "circle"), lineWidth = 5),
                                         scatter = list(marker = list(symbol = "circle"))) %>%
                          hc_yAxis_multiples(
                                # list(title = list(text = paste0(!!climVar(), " distribution")), min = 0, max = max(density_yaxis), opposite = TRUE),
                                # list(title = list(text = paste0(!!depVar())), min = 0, max = max(mod_vals$!!depVar()))
                                list(title = list(text = "", style = list(fontWeight = "bold",  fontSize = '1.2em')),
                                     labels = list(style = list(fontSize =  '1.2em')),
                                     min = 0, max = max(density_yaxis), opposite = TRUE),
                                list(title = list(text = impact_label, 
                                                  style = list(fontWeight = "bold", fontSize = '1.2em'),
                                     labels = list(style = list(fontSize =  '1.2em')), 
                                     min = 0, max = max(mod_vals$Dependent))
                                     ))%>%
                          hc_xAxis(
                              title = list(
                                    text = indicator_label, 
                                    style = list(
                                       fontWeight = "bold",  
                                      fontSize = '1.2em'
                                      )),
                               labels = list(style = list(fontSize =  '1.2em'))
                               ) %>%
                          hc_add_series(
                            data = density(mod_vals$Independent),
                            # data = density(mod_vals$!!climVar()),
                            type = 'area',
                            name = "Climate variable distribution",
                            # name = paste0(indicator_label, " distribution"),
                            yAxis = 0,
                            fillOpacity = 0.7) %>%
                          # hc_yAxis(title = list(text = "Dependent variable")) %>%
                          # hc_xAxis(title = list(text = "Fitted values")) %>%
                          hc_add_series(
                            data = dplyr::arrange(mod_vals, Independent),
                            # data = dplyr::arrange(mod_vals, `Precipitation`),
                            type = 'scatter',
                            name = "Observed",
                            # hcaes(x = Independent, y = Dependent),
                            # hcaes(x = `Precipitation`, y =  `Normalized direct shortage`),
                            hcaes(x = Independent, y =  Dependent),
                            yAxis = 1,
                            fillOpacity = 0.5) %>%
                          hc_add_series(
                            data = dplyr::arrange(mod_vals, Independent),
                            # data = dplyr::arrange(mod_vals, !!climVar()),
                            type = 'line',
                            name = "Fitted",
                            # hcaes(x = `Precipitation`, y = Fitted),
                            hcaes(x = Independent, y = Fitted),
                            yAxis = 1,
                            fillOpacity = 0.5
                          )  %>%
                          hc_colors(c("#91BEEA", "#34495E", "black")) %>% # "#5D6D7E"
                          hc_chart(plotBorderWidth = 0.5, plotBorderColor = '#b4b4b4', height = NULL)
                        #  ---- render predictors HC plot ----
             }
          })
                    
output$lmPlot <- renderHighchart({
          lmModelData()
                })

```



Water rights
=======================================
Column {data-width=450}
-----------------------------------------------------------------------
###
```{r}
valueBoxOutput("districtBoxNode")
```

### Nodes
```{r}
leafletOutput("nodeMap")
bsTooltip("nodeMap", "INSERT TEXT HERE",
                    "top", options = list(container = "body"))
```

```{r context="server"}
# render district value box at start
output$districtBoxNode <- renderValueBox(
                    valueBox(
                      value = "District",
                      color = "success"
                  )
                )

# Clicking on map 1 outputs Value boxes on both pages + catchment polygons + Dat table + success panel
observeEvent(input$districtMap_click, {
   if(!is.null(input$districtMap_click)) {
      click <- input$districtMap_click %>%
        data.frame() %>%
        dplyr::select(lat,lng)
      print(click)

      pt <- sf::st_as_sf(
        click,
        coords = c("lng", "lat"),
        crs = 4326
        )

      # point intersection w/ polygons
      pt_intersect <-  st_filter(shp, pt)

      # ensure  app will not crash if a somewhere other than a shape is clicked and returns no results from point-shape intersection
       if(nrow(pt_intersect) == 0) {
          NULL
       } else {
          district_id <- pt_intersect %>%
              rename(district = DISTRICT) %>%
              mutate(district = as.numeric(district))

          # District number value box
          output$districtBoxNode <- renderValueBox(
            valueBox(
              value = paste0("District ", district_id$district),
              color = "success"
              )
            )
          pal <- colorNumeric("YlOrRd", domain = shp$variance_rsq, n = 21)
          # bb = shp %>%
          #     st_bbox() %>%
          #     st_as_sfc() %>%
          #     st_transform(4326) %>%
          #     st_as_sf()
          # # Map 2 fly to bounds
          # bounds <- st_bbox(bb) %>%
          #     st_as_sfc() %>%
          #     st_buffer(0.009) %>%
          #     st_bbox() %>%
          #     as.vector()
       
          leafletProxy("districtMap") %>%
              clearMarkers() %>%
              clearShapes() %>%
              addMarkers(data = pt) %>%
              addPolygons(
                    data = shp,
                    color = "black",
                    fillOpacity = 0.8,
                    fillColor = ~pal(variance_rsq),
                    weight = 2,
                    label = ~DISTRICT,
                    labelOptions = labelOptions(
                      noHide = F,
                      # direction = 'center',
                      # textOnly = F)
                      style = list(
                        "color" = "black",
                        "font-weight" = "1000")
                  )
                ) 
          bb = shp %>%
              # filter(DISTRICT == 7) %>%
              filter(DISTRICT == district_id$district) %>%
              st_bbox() %>%
              st_as_sfc() %>%
              st_transform(4326) %>%
              st_as_sf()
          
          # Fly to bounds on Node map
          bounds <- st_bbox(bb) %>%
              st_as_sfc() %>%
              # st_buffer(0.009) %>%
              st_bbox() %>%
              as.vector()
          
          node_marker <- node_pts %>%
            # filter(district == 7) %>% 
            filter(district == district_id$district) %>%
            mutate(size = abs(avg_dem - mean(avg_dem))/ sd(avg_dem))
          
          leafletProxy("nodeMap") %>%
                clearMarkers() %>%
                clearShapes() %>%
                addPolygons(
                      data = filter(shp, DISTRICT == district_id$district),
                     # data = filter(shp, DISTRICT == 7),
                      fillColor = 'white',
                      fillOpacity = 0.5,
                      col = "black",
                      weight = 3,
                      label = ~DISTRICT,
                      labelOptions = labelOptions(
                          noHide = F,
                          # direction = 'center',
                          # textOnly = F)
                          style = list(
                            "color" = "black",
                            "font-weight" = "1000")
                          )
                      ) %>% 
                 addCircleMarkers(
                      data = node_marker,
                      radius = ~(4 + size*5),
                      # radius = 7,
                      color = "black",
                      fillColor ="red",
                      fillOpacity = 0.7,
                      weight = 3,
                      layerId = ~node_id,
                      stroke = TRUE) %>% 
                 flyToBounds(bounds[1], bounds[2], bounds[3], bounds[4])
      
          # output$nodeText <- renderText({
          #   paste0(node_marker)
          # })
 
       }
      }
  })
```

### Structure information {data-height=100}
```{r}
reactable::reactableOutput("nodeTable")
```

```{r context = "server"}
observeEvent(input$nodeMap_marker_click, {
    node <<- input$nodeMap_marker_click$id
    
    # base URL to CDSS website
    url <- "https://dwr.state.co.us/Tools/Structures/"
    
    # filter to specific WDID
   
    # all admins from node
    admins <- ditch_names %>%
        filter(node_id == node) %>%
        # filter(node_id == 3600729) %>%
        mutate(
          admin_number  = round(as.numeric(admin), 0 ),
          admin         = as.numeric(admin)
              ) %>%
        # mutate(admin_number = round(as.numeric(admin), 0 )) %>%
        dplyr::select(name, node_id, admin, admin_number) %>%
        group_by(admin) %>%
        slice(n = 1) %>%
        ungroup() %>%
        left_join(admin_dates, by = "admin_number") %>%
        dplyr::select(name, node_id, admin, date) %>% 
        mutate(
          cdss_url = paste0(url, node_id)
        )
    
    
        output$nodeTable <- reactable::renderReactable({
            reactable::reactable(admins,
                           columns = list(
                                name       = colDef(name = "Structure Name", align = "center"),
                                node_id    = colDef(name = "WDID", align = "center"),
                                admin      = colDef(name = "Priority Admin No.", align = "center"),
                                date       = colDef(name = "Appropriation Date", align = "center"),
                                cdss_url   = colDef(name = "CDSS URL", align = "center")
                              ),
                           highlight = TRUE, 
                           outlined = TRUE
                           )
                           
        })
  })
```


Column {data-width=450}
-----------------------------------------------------------------------
### Water districts
```{r}
leafletOutput("districtMap")
bsTooltip("districtMap", "INSERT TEXT HERE",
                    "bottom", options = list(container = "body"))
```

### Admin shortages
```{r}
highcharter::highchartOutput("adminShortagePlot")
bsTooltip("adminShortagePlot", "INSERT TEXT HERE",
                    "bottom", options = list(container = "body"))
```

```{r context="server"}
observeEvent(input$nodeMap_marker_click, {
    node <<- input$nodeMap_marker_click$id
    # ---- Node timeseries ----
    # filter data to node
    # ditch <- ditch_data %>%
    #   filter(node_id == node) %>%
    #   group_by(year, admin) %>%
    #   summarize(across(c(19:24), sum)) %>% 
    #   ungroup()
    
    # split node by admin
    node_split_short <- ditch_data %>% 
      filter(node_id == node) %>%
      # filter(node_id == "0700699") %>%
      mutate(admin = round(as.numeric(admin), 0)) %>% 
      group_by(admin) %>% 
      mutate(x = year, y = round(short_dir, 1)) %>% 
      dplyr::select(x, y, admin) %>% 
      group_split() %>% 
      as.list()
    
    # initialize highchart
    admin_short_hc <- highchart() %>% 
       hc_plotOptions(
                # series = list(label = list(enabled = FALSE)),
                line = list(marker = list(enabled = FALSE, symbol = "circle"), label = list(enabled = FALSE), lineWidth = 4),
                area = list(stacking = 'normal', label = list(enabled = FALSE)),
                column = list(stacking = 'normal', label = list(enabled = FALSE)),
                bar = list(stacking = 'normal', label = list(enabled = FALSE))
            ) %>%
        hc_title(text = "Shortages") %>% 
        hc_colors(viridis::cividis(n = length(node_split_short))) %>%
        hc_xAxis(categories = node_split_short[[1]][1],
                 labels = list(style = list(fontSize =  '1.1em'))) %>% 
        hc_yAxis(title = list(
                            text =  "Direct flow shortage (acre feet)",
                            style = list(fontWeight = "bold",  fontSize = '1.2em')),
                 labels = list(style = list(fontSize =  '1.1em'))) %>%  
        hc_chart(plotBorderWidth = 0.5, plotBorderColor = '#b4b4b4', height = NULL)
    
    # for loop to generate highcharter series for each admin number
    for (i in 1:length(node_split_short)) {
      admin_short_hc <- admin_short_hc %>%
          hc_add_series(node_split_short[[i]], name = paste0(node_split_short[[i]][1,3]), type = "area", fillOpacity = 1)
      }
      
    output$adminShortagePlot <- renderHighchart({
       admin_short_hc
      })
})
```

### Admin demand
```{r}
highcharter::highchartOutput("adminDemandPlot")
bsTooltip("adminDemandPlot", "INSERT TEXT HERE",
                    "top", options = list(container = "body"))
```

```{r context="server"}
observeEvent(input$nodeMap_marker_click, {
    node <<- input$nodeMap_marker_click$id
    
    node_split_demand <- ditch_data %>% 
      filter(node_id == node) %>%
      # filter(node_id == "0700699") %>%
      mutate(admin = round(as.numeric(admin), 0)) %>% 
      group_by(admin) %>% 
      mutate(x = year, y = round(demand_dir, 1)) %>% 
      dplyr::select(x, y, admin) %>% 
      group_split() %>% 
      as.list()
    
    # initialize highchart
    admin_dem_hc <- highchart() %>%
      highchart() %>% 
          hc_plotOptions(
              # series = list(label = list(enabled = FALSE)),
              line = list(marker = list(enabled = FALSE, symbol = "circle"), label = list(enabled = FALSE), lineWidth = 4),
              area = list(stacking = 'normal', label = list(enabled = FALSE)),
              column = list(stacking = 'normal', label = list(enabled = FALSE)),
              bar = list(stacking = 'normal', label = list(enabled = FALSE))
          ) %>%
          hc_title(text = "Demand") %>% 
          hc_colors(viridis::cividis(n = length(node_split_demand))) %>%
          hc_xAxis(categories = node_split_demand[[1]][1],
                   labels = list(style = list(fontSize =  '1.1em'))) %>% 
          hc_yAxis(title = list(
                              text =  "Demand (acre feet)",
                              style = list(fontWeight = "bold",  fontSize = '1.2em')),
                   labels = list(style = list(fontSize =  '1.1em'))) %>%  
          hc_chart(plotBorderWidth = 0.5, plotBorderColor = '#b4b4b4', height = NULL)
  
    
    # for loop to generate highcharter series for each admin number
    for (i in 1:length(node_split_demand)) {
      admin_dem_hc <- admin_dem_hc %>%
        hc_add_series(node_split_demand[[i]], name = paste0(node_split_demand[[i]][1,3]), type = "area", fillOpacity = 0.7)
      }
    
      
    output$adminDemandPlot <- renderHighchart({
       admin_dem_hc
      })
})
```



Climate change impacts
=====================================
Inputs {.sidebar}
----------------------------------------------------
### **Model inputs:**

*** 

<br>

##### **Climate model**
```{r}
selectInput(
  "datasetInput",
  label = NULL,
  # selected = "short_norm",
    # choices = as.list(outcome_lst$outcome_variable)
  selected = "MACA",
  choices = dataset_lst
)
bsTooltip("datasetInput", "INSERT TEXT HERE",
                    "right", options = list(container = "body"))
```

##### **Dependent variables**
```{r}
selectInput(
  "depClimChangeInput",
  label = NULL,
  # selected = "short_norm",
    # choices = as.list(outcome_lst$outcome_variable)
  selected = "Total shortage",
  choices = impacts_lst
)
bsTooltip("depClimChangeInput", "INSERT TEXT HERE",
                    "right", options = list(container = "body"))
```

<br>
<br>

##### **Drought indicators**
```{r}
selectInput(
  "climChangeVarInput",
  label = NULL,
  # selected = "prcp",
  # choices = as.list(indepent_lst$independent_variable)
  selected = "Precipitation",
  choices = clim_model_indicator_lst
  # choices = as.list(indepent_lst2$independent_variable)
  )
bsTooltip("climChangeVarInput", "INSERT TEXT HERE",
                    "right", options = list(container = "body"))

# actionButton(
#   "climVarHelpButton",
#   # label = "Help",
#   # class = "btn-primary btn-lg",
#   icon("question")
#   )
# 
# observeEvent(input$climVarHelpButton, {
#   shinyalert(title = "Hey",
#              showCancelButton = TRUE,
#              closeOnClickOutside = TRUE,
#              text = "Info on Drought indicators")
# })

```

<br>

####
```{r}
actionButton(
  "submitButton2",
  label = "Run model",
  class = "btn-primary btn-lg",
  icon("play")
  )
bsTooltip("submitButton2", "INSERT TEXT HERE",
                    "right", options = list(container = "body"))
```

<!-- ###  -->
<!-- ```{r} -->
<!-- actionButton( -->
<!--   "modelRunHelpButton", -->
<!--   # label = "Help", -->
<!--   # class = "btn-primary btn-lg", -->
<!--   icon("question") -->
<!--   ) -->

<!-- observeEvent(input$modelRunHelpButton, { -->
<!--   shinyalert(title = "Hey", -->
<!--              closeOnClickOutside = TRUE, -->
<!--              showCancelButton = TRUE, -->
<!--              text = "Press this button to run the model") -->
<!-- }) -->
<!-- ``` -->

***



```{r context = "server"}
# Dependent variable input reactive
futureDepVar <- reactive({
  input$depClimChangeInput
})

# climate variable input reactive
futureClimVar <- reactive({
  input$climChangeVarInput
})

climModel <- reactive({
  input$datasetInput
})
```

Column {data-width=250}
-----------------------------------------------------------------------

### 
```{r}
valueBoxOutput("districtBoxFuture")
```

### Water districts
```{r}
leafletOutput("districtMapFuture")
bsTooltip("districtMapFuture", "INSERT TEXT HERE",
                    "bottom", options = list(container = "body"))
```


```{r context="server"}
# render district value box at start
output$districtBoxFuture <- renderValueBox(
                    valueBox(
                      value = "District", 
                      color = "success"
                  )
                )

# Clicking on map 1 outputs Value boxes on both pages + catchment polygons + Dat table + success panel
observeEvent(input$districtMapFuture_click, {
   if(!is.null(input$districtMapFuture_click)) {
      click <- input$districtMapFuture_click %>%
        data.frame() %>%
        dplyr::select(lat,lng)
      print(click)

      pt <- sf::st_as_sf(
        click,
        coords = c("lng", "lat"),
        crs = 4326
        )

      # point intersection w/ polygons
      pt_intersect <-  st_filter(shp, pt)

      # ensure  app will not crash if a somewhere other than a shape is clicked and returns no results from point-shape intersection
       if(nrow(pt_intersect) == 0) {
          NULL
       } else {
          district_id <- pt_intersect %>%
              rename(district = DISTRICT) %>%
              mutate(district = as.numeric(district))

          # District number value box
          output$districtBoxFuture <- renderValueBox(
            valueBox(
              value = paste0("District ", district_id$district),
              color = "success"
              )
            )
          
          pal <- colorNumeric("YlOrRd", domain = shp$variance_rsq, n = 21)
          
          bb = shp %>%
              st_bbox() %>%
              st_as_sfc() %>%
              st_transform(4326) %>%
              st_as_sf()
          # Map 2 fly to bounds
          bounds <- st_bbox(bb) %>%
              st_as_sfc() %>%
              st_buffer(0.009) %>%
              st_bbox() %>%
              as.vector()
       
          leafletProxy("districtMapFuture") %>%
              clearMarkers() %>%
              clearShapes() %>%
              addMarkers(data = pt) %>%
              addPolygons(
                    data = shp,
                    fillColor = 'white',
                    fillOpacity = 0.5,
                    col = "black",
                    weight = 3,
                    label = ~DISTRICT,
                    labelOptions = labelOptions(
                        noHide = F,
                        # direction = 'center',
                        # textOnly = F)
                        style = list(
                          "color" = "black",
                          "font-weight" = "1000")
                      )
                  ) %>%
              addScaleBar("bottomleft") %>%
              addMeasure(
                position = "bottomleft",
                  primaryLengthUnit = "feet",
                  primaryAreaUnit = "sqmiles",
                  activeColor = "red",
                  completedColor = "green" ) %>%
            leafem::addMouseCoordinates() %>% 
            flyToBounds(bounds[1], bounds[2], bounds[3], bounds[4])
              # addPolygons(
              #       data = shp,
              #       color = "black",
              #       fillOpacity = 0.8,
              #       fillColor = ~pal(variance_rsq),
              #       weight = 2,
              #       label = ~DISTRICT,
              #       labelOptions = labelOptions(
              #         noHide = F,
              #         # direction = 'center',
              #         # textOnly = F)
              #         style = list(
              #           "color" = "black",
              #           "font-weight" = "1000")
              #     )
             
              # flyToBounds(bounds[1], bounds[2], bounds[3], bounds[4])
       }
    }
})
```


```{r context="server"}
# render district value box at start
# output$districtBoxFuture <- renderValueBox(
#                     valueBox(
#                       value = "District", 
#                       color = "success"
#                   )
#                 )

# Clicking on map 1 outputs Value boxes on both pages + catchment polygons + Dat table + success panel
observeEvent(input$districtMapFuture_click, {
   if(!is.null(input$districtMapFuture_click)) {
      click <- input$districtMapFuture_click %>%
        data.frame() %>%
        dplyr::select(lat,lng)
      print(click)

      pt <- sf::st_as_sf(
        click,
        coords = c("lng", "lat"),
        crs = 4326
        )

      # point intersection w/ polygons
      pt_intersect <-  st_filter(shp, pt)

      # ensure  app will not crash if a somewhere other than a shape is clicked and returns no results from point-shape intersection
       if(nrow(pt_intersect) == 0) {
          NULL
       } else {
          district_id <- pt_intersect %>%
              rename(district = DISTRICT) %>%
              mutate(district = as.numeric(district))
          
          # District number value box
          output$districtBoxFuture <- renderValueBox(
            valueBox(
              value = paste0("District ", district_id$district),
              color = "success"
              )
          )
          # output$splitBoxLM <- renderValueBox(
          #   valueBox(
          #     value   = paste0(splitRightsLM()),
          #     caption = "Priority date",
          #     color   = "success"
          #     )
          #   )
          bb = shp %>%
              st_bbox() %>%
              st_as_sfc() %>%
              st_transform(4326) %>%
              st_as_sf()
          # Map 2 fly to bounds
          bounds <- st_bbox(bb) %>%
              st_as_sfc() %>%
              st_buffer(0.009) %>%
              st_bbox() %>%
              as.vector()
          
          pal <- colorNumeric("YlOrRd", domain = shp$variance_rsq, n = 21)
          
          leafletProxy("districtMapFuture") %>%
              clearMarkers() %>%
              clearShapes() %>%
              addMarkers(data = pt) %>%
              addPolygons(
                    data = shp,
                    fillColor = 'white',
                    fillOpacity = 0.5,
                    col = "black",
                    weight = 3,
                    label = ~DISTRICT,
                    labelOptions = labelOptions(
                        noHide = F,
                        # direction = 'center',
                        # textOnly = F)
                        style = list(
                          "color" = "black",
                          "font-weight" = "1000")
                      )
                  ) %>%
              addScaleBar("bottomleft") %>%
              addMeasure(
                position = "bottomleft",
                  primaryLengthUnit = "feet",
                  primaryAreaUnit = "sqmiles",
                  activeColor = "red",
                  completedColor = "green" ) %>%
            leafem::addMouseCoordinates() %>% 
            flyToBounds(bounds[1], bounds[2], bounds[3], bounds[4])
              # addPolygons(
              #         data = shp,
              #         color = "black",
              #         fillOpacity = 0.8,
              #         fillColor = ~pal(variance_rsq),
              #         weight = 2,
              #         label = ~DISTRICT,
              #         labelOptions = labelOptions(
              #           noHide = F,
              #           # direction = 'center',
              #           # textOnly = F)
              #           style = list(
              #             "color" = "black",
              #             "font-weight" = "1000")
              #           )
              #         ) 
              # flyToBounds(bounds[1], bounds[2], bounds[3], bounds[4])
       }
    }
})

# ---- PRIORITY DATE ----
# output$splitBoxLM <- renderValueBox(
#             valueBox(
#               value = "Priority date",
#               color   = "success"
#               )
#             )

# splitRightsLM <- eventReactive(input$submitButton, {
#    click <- input$districtMapFuture_click %>%
#         data.frame() %>%
#         dplyr::select(lat,lng)
# 
#       pt <- sf::st_as_sf(
#         click,
#         coords = c("lng", "lat"),
#         crs = 4326
#         )
# 
#       # point intersection w/ polygons
#       pt_intersect <-  st_filter(shp, pt)
# 
#       # ensure  app will not crash if a somewhere other than a shape is clicked and returns no results from point-shape intersection
#       if(nrow(pt_intersect) == 0) {
#           NULL
#          } else {
#             district_id <- pt_intersect %>%
#                 rename(district = DISTRICT) %>%
#                 mutate(district = as.numeric(district))
#             
#             # adm_date <- admin_dates %>% 
#             #    filter(admin_number == adminNum())
#              # filter(admin_number == 4900)
#             
#             # paste0(adminNum(), ": ", adm_date$date)
#             breaks2 <- breaks %>% 
#                     # filter(district == 7) %>%
#                     filter(district == district_id$district) %>%
#                     ungroup() %>% 
#                     filter(demand_cuml_tot == split) %>% 
#                     dplyr::select(admin_number) %>% 
#                     head(1)
#             adm_date <- admin_dates %>%
#                  filter(admin_number == breaks2[[1]])
#             paste0(breaks2$admin_number, ": ", adm_date$date)
# 
#          }
# })


# Water rights admin number split value box
# output$splitBoxLM <- renderValueBox(
#         valueBox(
#           value   = paste0(splitRightsLM()),
#           caption = "Priority date",
#           color   = "success"
#           )
#         )
```

<!-- ### **Priority date** -->
<!-- ```{r} -->
<!-- valueBoxOutput("splitBoxLM") -->
<!-- ``` -->

### Model summary {data-height=75}
```{r}
formattable::formattableOutput("futureModelSummary")
bsTooltip("futureModelSummary", "INSERT TEXT HERE",
                    "top", options = list(container = "body"))
```

```{r context = "server"}
futureModelSummaryData <- eventReactive(input$submitButton2, {
   # if(!is.null(input$districtMapFuture_click)) {
    click <- input$districtMapFuture_click %>%
            data.frame() %>%
            dplyr::select(lat,lng)

          pt <- sf::st_as_sf(
            click,
            coords = c("lng", "lat"),
            crs = 4326
            )
          # point intersection w/ polygons
          pt_intersect <-  st_filter(shp, pt)

          # ensure  app will not crash if a somewhere other than a shape is clicked and returns no results from point-shape intersection
          if(nrow(pt_intersect) == 0) {
              NULL
             } else {
                district_id <- pt_intersect %>%
                    rename(district = DISTRICT) %>%
                    mutate(district = as.numeric(district))
                 # ---- Water supply data summarized to the year ----
                ws_data <- by_admin %>%
                  group_by(year, district) %>%
                  mutate(
                      year          = as.factor(year),
                      admin_number  = as.integer(round(admin, 0))
                  ) %>%
                  dplyr::filter(!year %in% c(1980, 2013)) %>%
                  group_by(basin, district, year) %>%
                  summarise(
                      short               = sum(short, na.rm = T),
                      short_dir           = sum(short_dir, na.rm = T),
                      demand              = sum(demand, na.rm = T),
                      supply              = sum(supply, na.rm = T),
                      supply_dir          = sum(supply_dir, na.rm = T)
                  ) %>%
                  mutate(
                      short_norm          = 100*(round(short/demand, 3)),
                      short_dir_norm      = 100*(round(short_dir/demand, 3)),
                      aug_supply          = round((supply - supply_dir), 3),
                      aug_supply_norm     = round(100*(aug_supply/supply), 3),
                      year                = as.factor(year)
                  )

                # ---- Join indicators & impacts data, summarize to district level ----
                by_district <- left_join(
                      ws_data,
                      dplyr::select(short_year, year = wyear, district, 20:41),
                      by = c("district", "year")
                ) %>%
                  # filter(district == 6) %>%
                  filter(district == district_id$district) %>%
                  dplyr::filter(!year %in% c(1980, 2013)) %>%
                  group_by(basin, district, year) %>%
                  summarise(
                        short               = sum(short, na.rm = T),
                        short_dir           = sum(short_dir, na.rm = T),
                        demand              = sum(demand, na.rm = T),
                        supply              = sum(supply, na.rm = T),
                        supply_dir          = sum(supply_dir, na.rm = T),
                        af_total            = mean(af_total, na.rm = T),
                        swe_max             = mean(swe_max, na.rm = T),
                        prcp                = mean(prcp, na.rm = T),
                        prcp_norm           = mean(prcp_norm, na.rm = T),
                        pdsi                = mean(pdsi, na.rm = T),
                        pdsi_gridmet        = mean(pdsi_gridmet, na.rm = T),
                        eddi1               = mean(eddi1, na.rm = T),
                        eddi3               = mean(eddi3, na.rm = T),
                        eddi6               = mean(eddi6, na.rm = T),
                        eddi12              = mean(eddi12, na.rm = T),
                        spi1                = mean(spi1, na.rm = T),
                        spi3                = mean(spi3, na.rm = T),
                        spi6                = mean(spi6, na.rm = T),
                        spi9                = mean(spi9, na.rm = T),
                        spi12               = mean(spi12, na.rm = T),
                        tavg                = mean(tavg, na.rm = T),
                        aet                 = mean(aet, na.rm = T),
                        pet                 = mean(pet, na.rm = T),
                        soilm               = mean(soilm, na.rm = T)
                  ) %>%
                  mutate(
                        short_norm          = 100*(round(short/demand, 3)),
                        short_dir_norm      = 100*(round(short_dir/demand, 3)),
                        aug_supply          = round((supply - supply_dir), 3),
                        aug_supply_norm     = round(100*(aug_supply/supply), 3),
                        year                = as.factor(year)
                  )
                # ---- log transform data ----
                trans_log <- by_district %>%
                      mutate(
                        short               = log10(short),
                        short_dir           = log10(short_dir),
                        short_norm          = log10(short_norm),
                        short_dir_norm      = log10(short_dir_norm),
                        aug_supply          = log10(aug_supply),
                        aug_supply_norm     = log10(aug_supply_norm),
                        supply              = log10(supply),
                        supply_dir          = log10(supply_dir),
                        demand              = log10(demand)
                      )

                  # replace Infinite w/ 0
                is.na(trans_log) <- sapply(trans_log, is.infinite)
                trans_log[is.na(trans_log)] <- 0

                trans_log <- trans_log %>%
                      # dplyr::select(short_dir_norm, prcp)
                      dplyr::select(futureDepVar(), futureClimVar())

                    # ---- Linear regression run, nested dataframe ----
                lm_run <- trans_log %>%
                        group_by(district) %>%
                        nest(-district) %>%
                        mutate(
                          fit       = map(data,
                                           # ~lm(short_dir_norm~prcp, data = .)),
                                           ~lm(as.formula(
                                             paste(futureDepVar()," ~ ", futureClimVar())
                                           ),
                                           data = .)),
                          results   = map(fit, augment),
                          tidied    = map(fit, tidy),
                          metrics   = map(fit, glance)
                        )

                 indicator_label <- names(clim_model_indicator_lst[grep(pattern = paste0("^", futureClimVar(), "$"), clim_model_indicator_lst)])
                 impact_label <- names(impacts_lst[grep(pattern = paste0("^", futureDepVar(), "$"), impacts_lst)])
                 # indicator_label <- names(clim_model_indicator_lst[grep(pattern = paste0("prcp"), clim_model_indicator_lst)])
                 # impact_label <- names(impacts_lst[grep(pattern = paste0("short_dir_norm"), impacts_lst)])
      
                 tbl_data <- lm_run %>%
                        unnest(c(metrics)) %>%
                        dplyr::select(district, tidied, r_squared = r.squared, p_value = p.value) %>%
                        unnest(c(tidied))  %>%
                        ungroup() %>%
                        dplyr::select(term, coefficient = estimate, r_squared, p_value) %>%
                        mutate(
                            coefficient   = round(coefficient, 3),
                            r_squared     = round(r_squared,3),
                            p_value       = round(p_value, 5)
                               ) %>%
                        # mutate(across(where(is.numeric), round, 3)) %>%
                        # mutate(across(where(is.numeric), as.character)) %>%
                        rename(
                            # District      = district,
                            Term          = term,
                            Coefficient   = coefficient,
                            "R Squared"   = r_squared,
                            "p-value"     = p_value
                        )
                  tbl_coeff <- tbl_data %>% 
                        filter(Term != "(Intercept)") %>% 
                        mutate(
                           Term = indicator_label
                           )
                   
                  tbl_int <- tbl_data %>% 
                        filter(Term == "(Intercept)") 
  
                  tbl_clean <- bind_rows(tbl_int, tbl_coeff)
                   
                  customGreen0 = "#DeF7E9"
                  customGreen = "#71CA97"
                  customRed = "#ff7f7f"
                  improvement_formatter <-
                        formatter("span",
                                  style = x ~ style(
                                    font.weight = "bold",
                                    color = ifelse(x > 0, customGreen, ifelse(x < 0, customRed, "black"))
                                    )
                                  )
                  format_tbl <-
                    formattable(tbl_clean,
                                align = c("l",rep("r", NCOL(tbl_data) - 1)),
                                list(
                                  `Term` = formatter("span", style = ~ style(color = "black", font.weight = "bold")),
                                  `Coefficient` = improvement_formatter,
                                  area(col = 3:4) ~ color_tile("#EAECEE", "#EAECEE"))
                                )
                  format_tbl
}})

output$futureModelSummary <- renderFormattable({
                  futureModelSummaryData()
                  })
```

Column {data-width=550}
-------------------------------------
### Timeseries
```{r}
highcharter::highchartOutput("climateTimeseries")
bsTooltip("climateTimeseries", "INSERT TEXT HERE",
                    "bottom", options = list(container = "body"))
```

```{r context = "server"}
projectedClimateData <- eventReactive(input$submitButton2, {
   # if(!is.null(input$districtMapFuture_click)) {
      click <- input$districtMapFuture_click %>%
            data.frame() %>%
            dplyr::select(lat,lng)

          pt <- sf::st_as_sf(
            click,
            coords = c("lng", "lat"),
            crs = 4326
            )
          # point intersection w/ polygons
          pt_intersect <-  st_filter(shp, pt)

          # ensure  app will not crash if a somewhere other than a shape is clicked and returns no results from point-shape intersection
          if(nrow(pt_intersect) == 0) {
              NULL
             } else {
                district_id <- pt_intersect %>%
                    rename(district = DISTRICT) %>%
                    mutate(district = as.numeric(district))
                 # ---- Water supply data summarized to the year ----
                ws_data <- by_admin %>%
                  group_by(year, district) %>%
                  mutate(
                      year          = as.factor(year),
                      admin_number  = as.integer(round(admin, 0))
                  ) %>%
                  dplyr::filter(!year %in% c(1980, 2013)) %>%
                  group_by(basin, district, year) %>%
                  summarise(
                      short               = sum(short, na.rm = T),
                      short_dir           = sum(short_dir, na.rm = T),
                      demand              = sum(demand, na.rm = T),
                      supply              = sum(supply, na.rm = T),
                      supply_dir          = sum(supply_dir, na.rm = T)
                  ) %>%
                  mutate(
                      short_norm          = 100*(round(short/demand, 3)),
                      short_dir_norm      = 100*(round(short_dir/demand, 3)),
                      aug_supply          = round((supply - supply_dir), 3),
                      aug_supply_norm     = round(100*(aug_supply/supply), 3),
                      year                = as.factor(year)
                  )
#                 
#                 # ---- Join indicators & impacts data, summarize to district level ----
                by_district <- left_join(
                        ws_data,
                        dplyr::select(short_year, year = wyear, district, 20:41),
                        by = c("district", "year")
                        ) %>%
                  # filter(district == 6) %>%
                  filter(district == district_id$district) %>%
                  dplyr::filter(!year %in% c(1980, 2013)) %>%
                  group_by(basin, district, year) %>%
                  summarise(
                        short               = sum(short, na.rm = T),
                        short_dir           = sum(short_dir, na.rm = T),
                        demand              = sum(demand, na.rm = T),
                        supply              = sum(supply, na.rm = T),
                        supply_dir          = sum(supply_dir, na.rm = T),
                        af_total            = mean(af_total, na.rm = T),
                        swe_max             = mean(swe_max, na.rm = T),
                        prcp                = mean(prcp, na.rm = T),
                        prcp_norm           = mean(prcp_norm, na.rm = T),
                        pdsi                = mean(pdsi, na.rm = T),
                        pdsi_gridmet        = mean(pdsi_gridmet, na.rm = T),
                        eddi1               = mean(eddi1, na.rm = T),
                        eddi3               = mean(eddi3, na.rm = T),
                        eddi6               = mean(eddi6, na.rm = T),
                        eddi12              = mean(eddi12, na.rm = T),
                        spi1                = mean(spi1, na.rm = T),
                        spi3                = mean(spi3, na.rm = T),
                        spi6                = mean(spi6, na.rm = T),
                        spi9                = mean(spi9, na.rm = T),
                        spi12               = mean(spi12, na.rm = T),
                        tavg                = mean(tavg, na.rm = T),
                        aet                 = mean(aet, na.rm = T),
                        pet                 = mean(pet, na.rm = T),
                        soilm               = mean(soilm, na.rm = T)
                  ) %>%
                  mutate(
                        short_norm          = 100*(round(short/demand, 3)),
                        short_dir_norm      = 100*(round(short_dir/demand, 3)),
                        aug_supply          = round((supply - supply_dir), 3),
                        aug_supply_norm     = round(100*(aug_supply/supply), 3),
                        year                = as.factor(year))
              

                trans_log <- by_district %>%
                      mutate(
                        short               = log10(short),
                        short_dir           = log10(short_dir),
                        short_norm          = log10(short_norm),
                        short_dir_norm      = log10(short_dir_norm),
                        aug_supply          = log10(aug_supply),
                        aug_supply_norm     = log10(aug_supply_norm),
                        supply              = log10(supply),
                        supply_dir          = log10(supply_dir),
                        demand              = log10(demand),
                        af_total            = log10(af_total)
                      ) %>%
                  ungroup() %>%
                  group_by(district)
                
                #     
                    # replace Infinite w/ 0
                  is.na(trans_log) <- sapply(trans_log, is.infinite)
                  trans_log[is.na(trans_log)] <- 0

                  trans_log <- trans_log %>%
                      # dplyr::select(short_dir_norm, aet)
                      dplyr::select(futureDepVar(), futureClimVar())
                  
                  
                  lm_run <- trans_log %>%
                        group_by(district) %>%
                        nest(-district) %>%
                        mutate(
                          fit       = map(data,
                                           # ~lm(short_dir_norm~aet, data = .)),
                                           ~lm(as.formula(
                                             paste0(futureDepVar()," ~ ", futureClimVar())
                                           ),
                                           data = .)),
                          # results   = map(fit, augment),
                          # tidied    = map(fit, tidy),
                          # metrics   = map(fit, glance)
                        ) %>% 
                        unnest(c(2)) %>%
                        # dplyr::select(district, short_dir_norm, aet, fit) %>%
                        dplyr::select(district, futureDepVar(), futureClimVar(), fit) %>%
                        setNames(c("district", "dependent", "independent", "model"))
                  
                  lm_fit <- lm_run$model[[1]]
                  
                  climate_proj <- climate_models %>% 
                    # filter(dataset == "MACA", district == 8, year >1950) %>%
                    # dplyr::select(year, aet) %>% 
                    filter(dataset == climModel(), district == district_id$district, year >1950) %>%
                    dplyr::select(year, futureClimVar()) %>%
                    mutate(across(where(is.numeric), round, 2))
                    # setNames(c("year", "climate_var"))
                  
            
                  pred_future <- predict(lm_fit, dplyr::select(climate_proj,  futureClimVar()))
                  # pred_future <- predict(lm_fit, dplyr::select(climate_proj, aet))
                  pred_df <- data.frame(year = 1951:2099, fitted = pred_future)
                   # pred_df <- left_join(pred_df, dplyr::select(future_data, -district), by = "year")
                   
                  pred_df <- pred_df %>%
                    ungroup() %>%
                    mutate(
                      prediction          = 10^fitted
                    ) %>% 
                    mutate(across(where(is.numeric), round, 1))

                    
                  indicator_label <- names(clim_model_indicator_lst[grep(pattern = paste0("^", futureClimVar(), "$"), clim_model_indicator_lst)])
                  impact_label <- names(impacts_lst[grep(pattern = paste0("^", futureDepVar(), "$"), impacts_lst)])
                    # indicator_label <- names(clim_model_indicator_lst[grep(pattern = paste0("aet"), clim_model_indicator_lst)])
                    # impact_label <- names(impacts_lst[grep(pattern = paste0("short_dir_norm"), impacts_lst)])
                  
                  #  historic climate variable data
                  indicator_historic <- by_district %>%
                      ungroup() %>%
                     dplyr::select(year, futureClimVar()) %>%
                      # dplyr::select(year, aet) %>%
                      mutate(
                          year    = as.numeric(as.character(year)),
                          source  = "historic"
                        )
                  # modeled climate variable
                  indicator_projected <- climate_proj %>%
                      filter(year >= 2013) %>%
                      mutate(source = "projected")
                  
                  # join historic climate variable data w/ modeled data
                  indicator_ts <- bind_rows(indicator_historic, indicator_projected)
                  
                  # historic impacts
                  impact_historic <- by_district %>%
                      ungroup() %>%
                      dplyr::select(year, futureDepVar()) %>%
                      # dplyr::select(year, short_dir_norm) %>%
                      mutate(
                         year    = as.numeric(as.character(year)),
                         source  = "historic"
                      ) %>% 
                      setNames(c("year", "impact", "source"))
                  
                  # predicted impacts
                  impact_projected <- pred_df %>%
                      filter(year >= 2013) %>%
                      dplyr::select(year, prediction) %>% 
                      mutate(source = "projected") %>% 
                      setNames(c("year", "impact", "source"))

                  # join historic impacts data w/ predicted impacts
                  impact_ts <- bind_rows(impact_historic, impact_projected)
                  
                  lm_hc <- 
                      highchart() %>%
                            hc_plotOptions(line = list(marker = list(enabled = FALSE, symbol = "circle"), lineWidth = 5),
                                           scatter = list(marker = list(symbol = "circle"))) %>%
                            hc_yAxis_multiples(
                              list(title = list(
                                text = indicator_label,
                                style  = list(fontWeight = "bold",  fontSize = '1.2em')),
                                labels = list(style = list(fontSize =  '1.2em')),
                                top      = "0%",
                                height = "50%",
                                opposite = TRUE),
                              list(title = list(
                                text  = impact_label,
                                style = list(fontWeight = "bold",  fontSize = '1.2em')
                              ),
                              labels = list(style = list(fontSize =  '1.2em')),
                                top = "50%",
                                height = "50%"
                              )
                            ) %>%
                          # hc_yAxis_multiples(
                          #     list(title = list(text = indicator_label, style = list(fontWeight = "bold",  fontSize = '1.2em')),
                          #          labels = list(style = list(fontSize =  '1.2em')),
                          #          min = 0, max = max(climate_proj$prcp), opposite = TRUE),
                          #     list(title = list(text = impact_label,
                          #                       style = list(fontWeight = "bold", fontSize = '1.2em'),
                          #                       labels = list(style = list(fontSize =  '1.2em')),
                          #                       min = 0, max =  max(pred_df$prediction)))) %>%
                            hc_xAxis(
                                title = list(text = "Year", style = list(fontWeight = "bold",fontSize = '1.2em'
                                )),
                                labels = list(style = list(fontSize =  '1.2em')),
                                plotBands = list(
                                  list(from =1981, to =2012, color = "rgba(0, 100, 0, 0.1)",
                                       label = list(text = "Historical record", style = list( color = "black", fontWeight = 'bold' ))))
                              ) %>%
                            hc_add_series(
                                data = dplyr::arrange(indicator_ts, year),
                                type = 'line', name = indicator_label,
                                # hcaes(x = year, y =  aet),
                                hcaes(x = year, y =  !!futureClimVar()),
                                yAxis = 0,fillOpacity = 0.5) %>%
                            hc_add_series(
                                data = dplyr::arrange(impact_ts, year),
                                type = 'column', name = impact_label,
                                # hcaes(x = Independent, y = Dependent),
                                hcaes(x = year, y =  impact),
                                yAxis = 1, fillOpacity = 0.5) %>% 
                            # hc_add_series(
                            #   data = dplyr::arrange(pred_df, year),
                            #   type = 'column', name = impact_label,
                            #   # hcaes(x = Independent, y = Dependent),
                            #   hcaes(x = year, y =  prediction),
                            #   yAxis = 1, fillOpacity = 0.5) %>% 
                            # hc_add_series(
                            #   data = dplyr::arrange(climate_proj, year),
                            #   type = 'line', name = indicator_label,
                            #   hcaes(x = year, y =  prcp),
                            #   # hcaes(x = year, y =  !!futureClimVar()),
                            #   yAxis = 0,fillOpacity = 0.5) %>%
                            hc_colors(c("#1EB1CD", "#C05555")) %>% # "#5D6D7E"
                            # hc_colors(c("#91BEEA", "#EE8E8C", "#34495E")) %>% # "#5D6D7E"
                            hc_chart(plotBorderWidth = 0.5, plotBorderColor = '#b4b4b4', height = NULL)
                    lm_hc
             }
})

output$climateTimeseries <- renderHighchart({
  projectedClimateData()
})
```


### Predicted Impacts 
```{r}
# plotly::plotlyOutput("wsTimeseries")
# highcharter::highchartOutput("lmPlot")
highcharter::highchartOutput("predictionPlot")
bsTooltip("predictionPlot", "INSERT TEXT HERE",
                    "top", options = list(container = "body"))
# verbatimTextOutput("lmPlot")
```

```{r context = "server"}
predictImpactsData <- eventReactive(input$submitButton2, {
   # if(!is.null(input$districtMapFuture_click)) {
      click <- input$districtMapFuture_click %>%
            data.frame() %>%
            dplyr::select(lat,lng)

          pt <- sf::st_as_sf(
            click,
            coords = c("lng", "lat"),
            crs = 4326
            )
          # point intersection w/ polygons
          pt_intersect <-  st_filter(shp, pt)

          # ensure  app will not crash if a somewhere other than a shape is clicked and returns no results from point-shape intersection
          if(nrow(pt_intersect) == 0) {
              NULL
             } else {
                district_id <- pt_intersect %>%
                    rename(district = DISTRICT) %>%
                    mutate(district = as.numeric(district))
                 # ---- Water supply data summarized to the year ----
                ws_data <- by_admin %>%
                  group_by(year, district) %>%
                  mutate(
                      year          = as.factor(year),
                      admin_number  = as.integer(round(admin, 0))
                  ) %>%
                  dplyr::filter(!year %in% c(1980, 2013)) %>%
                  group_by(basin, district, year) %>%
                  summarise(
                      short               = sum(short, na.rm = T),
                      short_dir           = sum(short_dir, na.rm = T),
                      demand              = sum(demand, na.rm = T),
                      supply              = sum(supply, na.rm = T),
                      supply_dir          = sum(supply_dir, na.rm = T)
                  ) %>%
                  mutate(
                      short_norm          = 100*(round(short/demand, 3)),
                      short_dir_norm      = 100*(round(short_dir/demand, 3)),
                      aug_supply          = round((supply - supply_dir), 3),
                      aug_supply_norm     = round(100*(aug_supply/supply), 3),
                      year                = as.factor(year)
                  )
              
                # ---- Join indicators & impacts data, summarize to district level ----
                by_district <- left_join(
                        ws_data,
                        dplyr::select(short_year, year = wyear, district, 20:41),
                        by = c("district", "year")
                        ) %>%
                  # filter(district == 6) %>%
                  filter(district == district_id$district) %>%
                  dplyr::filter(!year %in% c(1980, 2013)) %>%
                  group_by(basin, district, year) %>%
                  summarise(
                        short               = sum(short, na.rm = T),
                        short_dir           = sum(short_dir, na.rm = T),
                        demand              = sum(demand, na.rm = T),
                        supply              = sum(supply, na.rm = T),
                        supply_dir          = sum(supply_dir, na.rm = T),
                        af_total            = mean(af_total, na.rm = T),
                        swe_max             = mean(swe_max, na.rm = T),
                        prcp                = mean(prcp, na.rm = T),
                        prcp_norm           = mean(prcp_norm, na.rm = T),
                        pdsi                = mean(pdsi, na.rm = T),
                        pdsi_gridmet        = mean(pdsi_gridmet, na.rm = T),
                        eddi1               = mean(eddi1, na.rm = T),
                        eddi3               = mean(eddi3, na.rm = T),
                        eddi6               = mean(eddi6, na.rm = T),
                        eddi12              = mean(eddi12, na.rm = T),
                        spi1                = mean(spi1, na.rm = T),
                        spi3                = mean(spi3, na.rm = T),
                        spi6                = mean(spi6, na.rm = T),
                        spi9                = mean(spi9, na.rm = T),
                        spi12               = mean(spi12, na.rm = T),
                        tavg                = mean(tavg, na.rm = T),
                        aet                 = mean(aet, na.rm = T),
                        pet                 = mean(pet, na.rm = T),
                        soilm               = mean(soilm, na.rm = T)
                  ) %>%
                  mutate(
                        short_norm          = 100*(round(short/demand, 3)),
                        short_dir_norm      = 100*(round(short_dir/demand, 3)),
                        aug_supply          = round((supply - supply_dir), 3),
                        aug_supply_norm     = round(100*(aug_supply/supply), 3),
                        year                = as.factor(year))
              

                trans_log <- by_district %>%
                      mutate(
                        short               = log10(short),
                        short_dir           = log10(short_dir),
                        short_norm          = log10(short_norm),
                        short_dir_norm      = log10(short_dir_norm),
                        aug_supply          = log10(aug_supply),
                        aug_supply_norm     = log10(aug_supply_norm),
                        supply              = log10(supply),
                        supply_dir          = log10(supply_dir),
                        demand              = log10(demand),
                        af_total            = log10(af_total)
                      ) %>%
                  ungroup() %>%
                  group_by(district)
                  
                  # ---- replace Infinite w/ 0 ----
                  is.na(trans_log) <- sapply(trans_log, is.infinite)
                  trans_log[is.na(trans_log)] <- 0

                  trans_log <- trans_log %>%
                      # dplyr::select(short_dir_norm, aet)
                      dplyr::select(futureDepVar(), futureClimVar())
                      
                  
                  lm_run <- trans_log %>%
                        group_by(district) %>%
                        nest(-district) %>%
                        mutate(
                          fit       = map(data,
                                           # ~lm(short_dir_norm~aet, data = .)),
                                           ~lm(as.formula(
                                             paste0(futureDepVar()," ~ ", futureClimVar())
                                           ),
                                           data = .)),
                          results   = map(fit, augment),
                          tidied    = map(fit, tidy),
                          metrics   = map(fit, glance)
                        ) %>% 
                        unnest(c(4)) 
                  
                  lm_fit <- lm_run$fit[[1]]
                  
                  lm_run2 <- lm_run %>% 
                    # dplyr::select(district, short_dir_norm, aet, Fitted = .fitted) %>%
                    dplyr::select(district, futureDepVar(), futureClimVar(), Fitted = .fitted) %>%
                    setNames(c("district", "dependent_historic", "independent_historic", "fit_historic"))
                   
                    # # Extract fitted values and back transform Logs
                    # mod_vals <- lm_run2 %>%
                    #     ungroup() %>%
                    #     mutate(
                    #         dependent_historic          = 10^lm_run2$dependent_historic,
                    #         fit_historic                = 10^lm_run2$fit_historic
                    #     ) %>%
                    #     mutate(across(where(is.numeric), round, 1))

                    # density_vals_hist <- density(lm_run2$independent_historic)
                    # density_yaxis_hist <- density_vals_hist$y
                    
                   future_data <- climate_models %>%
                      filter(dataset == climModel(), district == district_id$district, year > 1950) %>%
                      dplyr::select(district, year, futureClimVar())
                        # filter(dataset == "MACA", district == 6, year >1950) %>%
                        # dplyr::select(district, year, aet)
                   
                
                   # pred_future <- predict(lm_fit, dplyr::select(future_data, aet))
                   pred_future <- predict(lm_fit, dplyr::select(future_data,  futureClimVar()))
                   pred_df <- data.frame(year = 1951:2099, fitted = pred_future)
                   pred_df <- left_join(pred_df, dplyr::select(future_data, -district), by = "year")
                   
                   pred_df <- pred_df %>%
                      ungroup() %>%
                      mutate(
                        prediction          = 10^fitted
                      ) %>% 
                      setNames(c("year", "fitted", "independent_future", "prediction")) %>% 
                      mutate(across(where(is.numeric), round, 3))
                  
                  # density_vals_future <- density(pred_df$independent_future)
                  # density_yaxis_future <- density_vals_future$y
                  
                                # sampled data for District
                  tmp_samples <- climate_samples %>%
                    filter(district == district_id$district) %>%
                    dplyr::select(district, id, contains(paste0(futureClimVar())))
                    # filter(district == 6) %>%
                    # dplyr::select(district, id, contains("aet"))
                  
                  # sampled data for District
                  # future <- future_samples %>%
                  #   filter(district == district_id$district) %>% 
                  #   dplyr::select(district, id, contains(paste0(climVar())))
                  #   # filter(district == 6) %>% 
                  #   # dplyr::select(district, id, contains("prcp"))
                  # 
                  # # sampled data for District
                  # historic <- hist_samples %>%
                  #   filter(district == district_id$district) %>% 
                  #   dplyr::select(district, id, contains(paste0(climVar())))
                    # filter(district == 6) %>% 
                    # dplyr::select(district, id, contains("prcp"))
                               # sampled data for District
                  # historic <- hist_samples %>%
                  #   filter(district == district_id$district) %>% 
                  #   dplyr::select(district, id, contains(paste0(climVar())))
                    # filter(district == 6) %>% 
                    # dplyr::select(district, id, contains("prcp"))
                
                  # Future density plot
                  density_future <- density(tmp_samples[[4]])
                  future_yaxis <- density_future$y
                  
                  # Historic density plot
                  density_hist <- density(tmp_samples[[3]])
                  hist_yaxis <- density_hist$y
                  
                  indicator_label <- names(clim_model_indicator_lst[grep(pattern = paste0("^", futureClimVar(), "$"), clim_model_indicator_lst)])
                  impact_label <- names(impacts_lst[grep(pattern = paste0("^", futureDepVar(), "$"), impacts_lst)])
                    # indicator_label <- names(clim_model_indicator_lst[grep(pattern = paste0("prcp"), clim_model_indicator_lst)])
                    # impact_label <- names(impacts_lst[grep(pattern = paste0("short_dir_norm"), impacts_lst)])
                    
                  lm_hc <- 
                      highchart() %>%
                          hc_plotOptions(line = list(marker = list(enabled = FALSE, symbol = "circle"), lineWidth = 5),
                                         scatter = list(marker = list(symbol = "circle"))) %>%
                      hc_yAxis_multiples(
                                list(title = list(text = "", style = list(fontWeight = "bold",  fontSize = '1.2em')),
                                                  labels = list(style = list(fontSize =  '1.2em')),
                                                  min = 0, max = pmax(max(future_yaxis), max(hist_yaxis)),
                                                  opposite = TRUE),
                                list(title = list(text = impact_label,
                                                  style = list(fontWeight = "bold", fontSize = '1.2em'),
                                                  labels = list(style = list(fontSize =  '1.2em')),
                                                  min = 0, max = max(pred_df$prediction)))) %>%
                          # hc_yAxis_multiples(
                          #     list(title = list(text = "", style = list(fontWeight = "bold",  fontSize = '1.2em')),
                          #          labels = list(style = list(fontSize =  '1.2em')),
                          #          min = 0, max = pmax(max(density_yaxis_future), max(density_yaxis_hist)), opposite = TRUE),
                          #     list(title = list(text = impact_label,
                          #                       style = list(fontWeight = "bold", fontSize = '1.2em'),
                          #                       labels = list(style = list(fontSize =  '1.2em')),
                          #                       min = 0, max = max(pred_df$prediction)))) %>%
                          hc_xAxis(
                            title = list(
                              text = indicator_label,
                              style = list(
                                fontWeight = "bold",
                                fontSize = '1.2em')),
                            labels = list(style = list(fontSize =  '1.2em'))) %>%
                          hc_add_series(
                            # data = density(lm_run2$independent_historic),
                            data = density(tmp_samples[[3]]),
                            type = 'area',
                            # name = "Historic climate variable distribution",
                            name = paste0(indicator_label, " historic distribution"),
                            yAxis = 0, fillOpacity = 0.7) %>%
                          hc_add_series(
                            # data = density(pred_df$independent_future),
                            data = density(tmp_samples[[4]]),
                            type = 'area',
                            # name = "Projected climate variable distribution",
                            name = paste0(indicator_label, " projected distribution"),
                            yAxis = 0, fillOpacity = 0.7) %>%
                          hc_add_series(
                            data = dplyr::arrange(pred_df, independent_future),
                            type = 'line', name = impact_label,
                            hcaes(x = independent_future, y =  prediction),
                            yAxis = 1, fillOpacity = 0.7) %>% 
                     # hc_colors(c("#C05555", "#55C0C0", "black")) %>% # "#5D6D7E"
                     # hc_colors(c("#6DC878", "#C86DBD", "black")) %>% # "#5D6D7E"
                          hc_colors(c("#50A15D", "#71DC83", "black")) %>% # "#5D6D7E"
                          hc_chart(plotBorderWidth = 0.5, plotBorderColor = '#b4b4b4', height = NULL)
                  
                  lm_hc
             }
})

output$predictionPlot <- renderHighchart({
  predictImpactsData()
})
```


























